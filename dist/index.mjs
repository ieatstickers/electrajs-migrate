import*as t from"@electra/utility";import*as e from"chalk";var i,n={d:(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},o={};n.d(o,{ln:()=>s,YB:()=>E,HB:()=>i,z4:()=>V,RD:()=>f});class s{}!function(t){t.INT="INT",t.TINYINT="TINYINT",t.SMALLINT="SMALLINT",t.MEDIUMINT="MEDIUMINT",t.BIGINT="BIGINT"}(i||(i={}));const a=(d={Validators:()=>t.Validators},l={},n.d(l,d),l);var d,l;const r=(t=>{var e={};return n.d(e,t),e})({default:()=>e.default});class h{static red(t){console.log(r.default.redBright(t))}static blue(t){console.log(r.default.blueBright(t))}static green(t){console.log(r.default.greenBright(t))}static yellow(t){console.log(r.default.yellowBright(t))}}class c{validateName(t){const{valid:e,message:i}=a.Validators.all([a.Validators.string(),a.Validators.minLength(1),a.Validators.regex(/^[a-zA-Z_][a-zA-Z0-9_]{0,63}$/,"A-z, 0-9 and/or _")]).validate(t);if(!e)throw new TypeError(`Invalid ${this.constructor.name} name: ${i}`);return!0}validateOptions(t,e){const{valid:i,message:n}=a.Validators.schema(e).validate(t);if(!i)throw new TypeError(`Invalid ${this.constructor.name} options. ${n}`);return!0}addNullableStatement(t,e){return e?`${t} NULL`:`${t} NOT NULL`}addDefaultStatement(t,e){return void 0!==e?`${t} DEFAULT ${e}`:t}addIndexStatement(t,e,i){return e?`${t}, ADD INDEX (${i})`:t}addUnsignedStatement(t,e){return e?`${t} UNSIGNED`:t}addZeroFillStatement(t,e){return e?`${t} ZEROFILL`:t}addAutoIncrementStatement(t,e){return e?`${t} AUTO_INCREMENT`:t}addPrimaryKeyStatement(t,e){return e?`${t} PRIMARY KEY`:t}addAfterStatement(t,e,i){return!i&&e&&h.yellow("WARNING: addAfter option is ignored when creating a new table."),i?(e&&(t+=` AFTER ${e}`),t):t}}class u extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({type:i.INT,nullable:!1,default:void 0,unsigned:!1,autoIncrement:!1,zeroFill:!1,primaryKey:!1,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:a.Validators.enumValue(i),nullable:a.Validators.boolean(),default:a.Validators.integer({optional:!0}),unsigned:a.Validators.boolean(),autoIncrement:a.Validators.boolean(),zeroFill:a.Validators.boolean(),primaryKey:a.Validators.boolean(),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} ${this.options.type}`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,this.options.default),s=this.addUnsignedStatement(s,this.options.unsigned),s=this.addAutoIncrementStatement(s,this.options.autoIncrement),s=this.addZeroFillStatement(s,this.options.zeroFill),s=this.addPrimaryKeyStatement(s,this.options.primaryKey),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}class p extends u{constructor(t){super(t,{type:i.INT,nullable:!1,default:void 0,unsigned:!1,autoIncrement:!0,zeroFill:!1,primaryKey:!0,index:!1})}}var f;class y extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,unsigned:!1,zeroFill:!1,precision:10,scale:2,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.number({optional:!0}),unsigned:a.Validators.boolean(),zeroFill:a.Validators.boolean(),precision:a.Validators.integer(),scale:a.Validators.integer(),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} DECIMAL(${this.options.precision}, ${this.options.scale})`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,"number"==typeof this.options.default?this.options.default.toFixed(this.options.scale):void 0),s=this.addUnsignedStatement(s,this.options.unsigned),s=this.addZeroFillStatement(s,this.options.zeroFill),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}!function(t){t.CHAR="CHAR",t.VARCHAR="VARCHAR",t.TEXT="TEXT",t.TINYTEXT="TINYTEXT",t.MEDIUMTEXT="MEDIUMTEXT",t.LONGTEXT="LONGTEXT"}(f||(f={}));class v extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name);const i=(null==e?void 0:e.type)||f.VARCHAR;this.options=Object.assign({type:i,nullable:!1,primaryKey:!1,default:void 0,length:i!==f.VARCHAR?void 0:255,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:a.Validators.enumValue(f),nullable:a.Validators.boolean(),primaryKey:a.Validators.boolean(),default:a.Validators.string({optional:!0}),length:a.Validators.integer({optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} ${this.options.type}`;this.options.type!==f.CHAR&&this.options.type!==f.VARCHAR||void 0!==this.options.length&&(s+=`(${this.options.length})`),s=this.addNullableStatement(s,this.options.nullable),s=this.addPrimaryKeyStatement(s,this.options.primaryKey),s=this.addDefaultStatement(s,this.options.default?`'${this.options.default}'`:void 0),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}class m extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,"YYYY-MM-DD",{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} DATE`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,this.options.default?`'${this.options.default}'`:void 0),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}class A extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,addAfter:void 0},e),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"HH:MM:SS",{optional:!0}),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} TIME`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,this.options.default?`'${this.options.default}'`:void 0),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i),i?yield t.query(`CREATE TABLE ${o} (${s});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${s};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}var E;class b extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]) ([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"YYYY-MM-DD HH:MM:SS",{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} DATETIME`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,this.options.default?`'${this.options.default}'`:void 0),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}!function(t){t.BLOB="BLOB",t.TINYBLOB="TINYBLOB",t.MEDIUMBLOB="MEDIUMBLOB",t.LONGBLOB="LONGBLOB"}(E||(E={}));class T extends c{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({type:E.BLOB,nullable:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:a.Validators.enumValue(E),nullable:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} ${this.options.type}`;s=this.addNullableStatement(s,this.options.nullable),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i),i?yield t.query(`CREATE TABLE ${o} (${s});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${s};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}class $ extends c{constructor(t,e,i){super(),this.name=t,this.validateName(this.name),this.values=e;const{valid:n,message:o}=a.Validators.all([a.Validators.array(a.Validators.all([a.Validators.string(),a.Validators.minLength(1)])),a.Validators.minLength(1)]).validate(this.values);if(!n)throw new TypeError(`Invalid ${this.constructor.name} values. ${o}`);this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},i);const s={};for(const t of this.values)s[t]=t;this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.enumValue(s,{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}create(t,e,i){return n=this,o=void 0,a=function*(){const n=yield t.escape(this.name),o=yield t.escape(e);let s=`${n} ENUM('${this.values.join("', '")}')`;s=this.addNullableStatement(s,this.options.nullable),s=this.addDefaultStatement(s,this.options.default?`'${this.options.default}'`:void 0),s=this.addAfterStatement(s,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!i);let a=i?`CREATE TABLE ${o} (${s})`:`ALTER TABLE ${o} ADD COLUMN ${s}`;a=this.addIndexStatement(a,this.options.index,n),yield t.query(`${a};`)},new((s=void 0)||(s=Promise))((function(t,e){function i(t){try{l(a.next(t))}catch(t){e(t)}}function d(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(i,d)}l((a=a.apply(n,o||[])).next())}));var n,o,s,a}}var x=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function a(t){try{l(n.next(t))}catch(t){s(t)}}function d(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,d)}l((n=n.apply(t,e||[])).next())}))};class L{constructor(t,e,i,n){this.operations=[],this.name=t,this.connection=e,this.operations=i,this.tableExists=n}id(t="id"){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const e=new p(t);yield e.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}int(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new u(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}decimal(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new y(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}string(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new v(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}enum(t,e,i){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const n=new $(t,e,i);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}date(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new m(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}time(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new A(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}datetime(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new b(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}blob(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){const i=new T(t,e);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}renameColumn(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} RENAME COLUMN ${yield this.connection.escape(t)} TO ${yield this.connection.escape(e)};`)})))),this}dropColumn(t){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} DROP COLUMN ${yield this.connection.escape(t)};`)})))),this}addColumnIndex(t){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} ADD INDEX ${yield this.connection.escape(t)};`)})))),this}dropColumnIndex(t){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} DROP INDEX ${yield this.connection.escape(t)};`)})))),this}setColumnNullable(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} MODIFY COLUMN ${yield this.connection.escape(t)} ${e?"NULL":"NOT NULL"};`)})))),this}setColumnDefault(t,e){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} MODIFY COLUMN ${yield this.connection.escape(t)} DEFAULT ${"string"==typeof e?`'${e}'`:e};`)})))),this}drop(){return this.operations.push((()=>x(this,void 0,void 0,(function*(){yield this.connection.query(`DROP TABLE ${yield this.connection.escape(this.name)};`)})))),this}}class N{constructor(t,e){this.connection=t,this.operations=e}create(t){return new L(t,this.connection,this.operations,!1)}table(t){return new L(t,this.connection,this.operations,!0)}}var g=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function a(t){try{l(n.next(t))}catch(t){s(t)}}function d(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,d)}l((n=n.apply(t,e||[])).next())}))};class V{constructor(t){this.operations=[],this.connections=t}database(t,e){let i;if(e)i=this.connections.get(e);else{const e=this.connections.getAllByDatabaseName(t);if(0===e.length)throw new Error(`No connections found for database "${t}"`);if(e.length>1)throw new Error(`Multiple connections found for database "${t}". Connection name must be specified.`);i=e[0]}return this.operations.push((()=>g(this,void 0,void 0,(function*(){yield i.query(`CREATE DATABASE IF NOT EXISTS ${yield i.escape(t)};`)})))),this.operations.push((()=>g(this,void 0,void 0,(function*(){yield i.query(`USE ${yield i.escape(t)};`)})))),new N(i,this.operations)}executePendingOperations(){return g(this,void 0,void 0,(function*(){for(;this.operations.length>0;){const t=this.operations.shift();yield t()}}))}}var I=o.ln,w=o.YB,D=o.HB,O=o.z4,S=o.RD;export{I as AbstractMigration,w as BlobColumnTypeEnum,D as IntColumnTypeEnum,O as MySql,S as StringColumnTypeEnum};
//# sourceMappingURL=index.mjs.map