import*as t from"@electra/utility";import*as i from"chalk";var e,n={d:(t,i)=>{for(var e in i)n.o(i,e)&&!n.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:i[e]})},o:(t,i)=>Object.prototype.hasOwnProperty.call(t,i)},o={};n.d(o,{ln:()=>s,YB:()=>f,HB:()=>e,z4:()=>z,RD:()=>p});class s{}!function(t){t.INT="INT",t.TINYINT="TINYINT",t.SMALLINT="SMALLINT",t.MEDIUMINT="MEDIUMINT",t.BIGINT="BIGINT"}(e||(e={}));const a=(l={Validators:()=>t.Validators},r={},n.d(r,l),r);var l,r;const d=(t=>{var i={};return n.d(i,t),i})({default:()=>i.default});class u{static red(t){console.log(d.default.redBright(t))}static blue(t){console.log(d.default.blueBright(t))}static green(t){console.log(d.default.greenBright(t))}static yellow(t){console.log(d.default.yellowBright(t))}}class h{constructor(t){this.name=t,this.validateName(this.name)}getIndexDefinition(){return null}getName(){return this.name}validateName(t){const{valid:i,message:e}=a.Validators.all([a.Validators.string(),a.Validators.minLength(1),a.Validators.regex(/^[a-zA-Z_][a-zA-Z0-9_]{0,63}$/,"A-z, 0-9 and/or _")]).validate(t);if(!i)throw new TypeError(`Invalid ${this.constructor.name} name: ${e}`);return!0}validateOptions(t,i){const{valid:e,message:n}=a.Validators.schema(i).validate(t);if(!e)throw new TypeError(`Invalid ${this.constructor.name} options. ${n}`);return!0}addNullableStatement(t,i){return i?`${t} NULL`:`${t} NOT NULL`}addDefaultStatement(t,i){return void 0!==i?`${t} DEFAULT ${i}`:t}addIndexStatement(t,i,e){return i?`${t}, ADD INDEX (${e})`:t}addUnsignedStatement(t,i){return i?`${t} UNSIGNED`:t}addZeroFillStatement(t,i){return i?`${t} ZEROFILL`:t}addAutoIncrementStatement(t,i){return i?`${t} AUTO_INCREMENT`:t}addPrimaryKeyStatement(t,i){return i?`${t} PRIMARY KEY`:t}addAfterStatement(t,i,e){return!e&&i&&u.yellow("WARNING: addAfter option is ignored when creating a new table."),e?(i&&(t+=` AFTER ${i}`),t):t}}var c,p,f,m,g;!function(t){t.INDEX="INDEX",t.UNIQUE="UNIQUE",t.FULLTEXT="FULLTEXT"}(c||(c={}));class b{constructor(){this.indexColumns=[],this.indexType=c.INDEX}static create(){return new b}defaultName(t){return this.defaultIndexName=t,this}name(t){return this.indexName=t,this}columns(...t){return this.indexColumns.push(...t),this}type(t){return this.indexType=t,this}get(){if(!this.indexColumns.length)throw new Error("No columns defined for index");const t=this.indexName||this.defaultIndexName;let i=t&&this.indexType===c.UNIQUE?`${this.indexType} INDEX`:this.indexType;return t&&(i+=` \`${t}\``),i+=` (${this.indexColumns.map((t=>`\`${t}\``)).join(", ")})`,i}}class A{constructor(t,i){this.options={nullable:void 0,default:void 0,unsigned:void 0,autoIncrement:void 0,zeroFill:void 0,primaryKey:void 0,after:void 0},this.name=t,this.type=i}static create(t,i){return new A(t,i)}nullable(t){return this.options.nullable=t,this}default(t){return this.options.default=t,this}unsigned(t){return this.options.unsigned=t,this}autoIncrement(t){return this.options.autoIncrement=t,this}zeroFill(t){return this.options.zeroFill=t,this}primaryKey(t){return this.options.primaryKey=t,this}after(t){return this.options.after=t,this}get(){let t=`\`${this.name}\` ${this.type}`;return!0===this.options.unsigned&&(t+=" UNSIGNED"),"boolean"==typeof this.options.nullable&&(t+=this.options.nullable?" NULL":" NOT NULL"),void 0!==this.options.default&&(t+=` DEFAULT ${this.options.default}`),!0===this.options.autoIncrement&&(t+=" AUTO_INCREMENT"),!0===this.options.zeroFill&&(t+=" ZEROFILL"),!0===this.options.primaryKey&&(t+=" PRIMARY KEY"),"string"==typeof this.options.after&&(t+=` AFTER \`${this.options.after}\``),t}}class y extends h{constructor(t,i){super(t),this.options=Object.assign({type:e.INT,nullable:!1,default:void 0,unsigned:!1,autoIncrement:!1,zeroFill:!1,primaryKey:!1,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{type:a.Validators.enumValue(e),nullable:a.Validators.boolean(),default:a.Validators.integer({optional:!0}),unsigned:a.Validators.boolean(),autoIncrement:a.Validators.boolean(),zeroFill:a.Validators.boolean(),primaryKey:a.Validators.boolean(),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,this.options.type).nullable(this.options.nullable).default(this.options.default).unsigned(this.options.unsigned).autoIncrement(this.options.autoIncrement).zeroFill(this.options.zeroFill).primaryKey(this.options.primaryKey).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}class I extends y{constructor(t){super(t,{type:e.INT,nullable:!1,default:void 0,unsigned:!0,autoIncrement:!0,zeroFill:!1,primaryKey:!0,index:!1})}}class T extends h{constructor(t,i){super(t),this.options=Object.assign({nullable:!1,default:void 0,unsigned:!1,zeroFill:!1,precision:10,scale:2,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.number({optional:!0}),unsigned:a.Validators.boolean(),zeroFill:a.Validators.boolean(),precision:a.Validators.integer(),scale:a.Validators.integer(),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,`DECIMAL(${this.options.precision}, ${this.options.scale})`).nullable(this.options.nullable).default("number"==typeof this.options.default?this.options.default.toFixed(this.options.scale):void 0).unsigned(this.options.unsigned).zeroFill(this.options.zeroFill).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}!function(t){t.CHAR="CHAR",t.VARCHAR="VARCHAR",t.TEXT="TEXT",t.TINYTEXT="TINYTEXT",t.MEDIUMTEXT="MEDIUMTEXT",t.LONGTEXT="LONGTEXT"}(p||(p={}));class N extends h{constructor(t,i){super(t);const e=(null==i?void 0:i.type)||p.VARCHAR;this.options=Object.assign({type:e,nullable:!1,primaryKey:!1,default:void 0,length:e!==p.VARCHAR?void 0:255,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{type:a.Validators.enumValue(p),nullable:a.Validators.boolean(),primaryKey:a.Validators.boolean(),default:a.Validators.string({optional:!0}),length:a.Validators.integer({optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){let t=this.options.type;return this.options.type!==p.CHAR&&this.options.type!==p.VARCHAR||void 0!==this.options.length&&(t+=`(${this.options.length})`),A.create(this.name,t).nullable(this.options.nullable).primaryKey(this.options.primaryKey).default(this.options.default?`'${this.options.default}'`:void 0).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}class v extends h{constructor(t,i){super(t),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,"YYYY-MM-DD",{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,"DATE").nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}class E extends h{constructor(t,i){super(t),this.options=Object.assign({nullable:!1,default:void 0,addAfter:void 0},i),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"HH:MM:SS",{optional:!0}),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,"TIME").nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).after(this.options.addAfter)}}class D extends h{constructor(t,i){super(t),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]) ([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"YYYY-MM-DD HH:MM:SS",{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,"DATETIME").nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}!function(t){t.BLOB="BLOB",t.TINYBLOB="TINYBLOB",t.MEDIUMBLOB="MEDIUMBLOB",t.LONGBLOB="LONGBLOB"}(f||(f={}));class x extends h{constructor(t,i){super(t),this.options=Object.assign({type:f.BLOB,nullable:!1,addAfter:void 0},i),this.validateOptions(this.options,{type:a.Validators.enumValue(f),nullable:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,this.options.type).nullable(this.options.nullable).after(this.options.addAfter)}}class V extends h{constructor(t,i,e){super(t),this.values=i;const{valid:n,message:o}=a.Validators.all([a.Validators.array(a.Validators.all([a.Validators.string(),a.Validators.minLength(1)])),a.Validators.minLength(1)]).validate(this.values);if(!n)throw new TypeError(`Invalid ${this.constructor.name} values. ${o}`);this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},e);const s={};for(const t of this.values)s[t]=t;this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.enumValue(s,{optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})})}getColumnDefinition(){return A.create(this.name,`ENUM('${this.values.join("', '")}')`).nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}class M extends h{constructor(t,i){if(super(t),this.options=Object.assign({nullable:!1,default:void 0,zeroFill:!1,precision:void 0,scale:void 0,index:!1,addAfter:void 0},i),this.validateOptions(this.options,{nullable:a.Validators.boolean(),default:a.Validators.number({optional:!0}),zeroFill:a.Validators.boolean(),precision:a.Validators.integer({optional:!0}),scale:a.Validators.integer({optional:!0}),index:a.Validators.boolean(),addAfter:a.Validators.string({optional:!0})}),!(null==this.options.precision&&null==this.options.scale||null!=this.options.precision&&null!=this.options.scale))throw new Error(`Precision and scale must be both defined or both undefined in column ${this.name}`)}getColumnDefinition(){const t=null!=this.options.precision&&null!=this.options.scale?`DOUBLE(${this.options.precision}, ${this.options.scale})`:"DOUBLE";return A.create(this.name,t).nullable(this.options.nullable).default("number"==typeof this.options.default?this.options.default.toFixed(this.options.scale):void 0).zeroFill(this.options.zeroFill).after(this.options.addAfter)}getIndexDefinition(){return this.options.index?b.create().columns(this.name):null}}!function(t){t.UTF8="utf8",t.UTF8MB4="utf8mb4"}(m||(m={})),function(t){t.UTF8_GENERAL_CI="utf8_general_ci",t.UTF8MB4_GENERAL_CI="utf8mb4_general_ci",t.UTF8MB4_UNICODE_CI="utf8mb4_unicode_ci"}(g||(g={}));class ${constructor(t,i){this.currentName=t,this.newName=i}getModificationDefinition(){return`RENAME COLUMN \`${this.currentName}\` TO \`${this.newName}\``}}class L{constructor(t){this.name=t}getModificationDefinition(){return`DROP COLUMN \`${this.name}\``}}class O{constructor(t){this.definition=t}getModificationDefinition(){return`ADD ${this.definition.get()}`}}class w{constructor(t){this.name=t}getModificationDefinition(){return`DROP INDEX \`${this.name}\``}}class C{constructor(t,i){this.name=t,this.nullable=i}getModificationDefinition(){return`MODIFY COLUMN \`${this.name}\` ${this.nullable?"NULL":"NOT NULL"}`}}class U{constructor(t,i){this.name=t,this.defaultValue=i}getModificationDefinition(){let t=this.defaultValue;return"string"==typeof t?t=`'${t}'`:null==t&&(t="NULL"),`MODIFY COLUMN \`${this.name}\` DEFAULT ${t}`}}class F{constructor(t){this.name=t}getModificationDefinition(){return`DROP TABLE IF EXISTS \`${this.name}\``}}class B{constructor(t,i,e,n,o){this.columnAdditions=[],this.columnModifications=[],this.tableModifications=[],this.name=t,this.connection=i,this.tableExists=n;const s=Object.assign({},{encoding:m.UTF8MB4,collation:g.UTF8MB4_GENERAL_CI},o);e.push((()=>{return t=this,i=void 0,n=function*(){if(0!==this.columnAdditions.length||0!==this.columnModifications.length||0!==this.tableModifications.length){if(!this.tableExists&&this.columnAdditions.length>0){const t=this.getCreateTableQuery(this.columnAdditions,s);t&&(yield this.connection.query(t),this.tableExists=!0,this.columnAdditions.splice(0,this.columnAdditions.length))}if(this.columnAdditions.length>0||this.columnModifications.length>0){const t=this.getAlterTableQuery(this.columnAdditions,this.columnModifications);t&&(yield this.connection.query(t))}if(this.tableModifications.length>0){const t=this.tableModifications.map((t=>t.getModificationDefinition())).join("; ");yield this.connection.query(`${t};`)}}},new((e=void 0)||(e=Promise))((function(o,s){function a(t){try{r(n.next(t))}catch(t){s(t)}}function l(t){try{r(n.throw(t))}catch(t){s(t)}}function r(t){var i;t.done?o(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(a,l)}r((n=n.apply(t,i||[])).next())}));var t,i,e,n}))}id(t="id"){return this.columnAdditions.push(new I(t)),this}int(t,i){return this.columnAdditions.push(new y(t,i)),this}decimal(t,i){return this.columnAdditions.push(new T(t,i)),this}double(t,i){return this.columnAdditions.push(new M(t,i)),this}string(t,i){return this.columnAdditions.push(new N(t,i)),this}enum(t,i,e){return this.columnAdditions.push(new V(t,i,e)),this}date(t,i){return this.columnAdditions.push(new v(t,i)),this}time(t,i){return this.columnAdditions.push(new E(t,i)),this}datetime(t,i){return this.columnAdditions.push(new D(t,i)),this}blob(t,i){return this.columnAdditions.push(new x(t,i)),this}renameColumn(t,i){return this.columnModifications.push(new $(t,i)),this}dropColumn(t){return this.columnModifications.push(new L(t)),this}addIndex(t,i,e){const n=b.create().defaultName(this.getDefaultIndexName(...t)).columns(...t);return i&&n.name(i),e&&n.type(e),this.columnModifications.push(new O(n)),this}dropIndex(...t){const[i]=t,e=Array.isArray(i)?this.getDefaultIndexName(...i):i;return this.columnModifications.push(new w(e)),this}setNullable(t,i){return this.columnModifications.push(new C(t,i)),this}setDefault(t,i){return this.columnModifications.push(new U(t,i)),this}drop(){return this.tableModifications.push(new F(this.name)),this}getDefaultIndexName(...t){const i=t.sort().join("_").toLowerCase();return`${this.name.toLowerCase()}_${i}_index`}getCreateTableQuery(t,i){const e=[...t.map((t=>t.getColumnDefinition().get())),...t.map((t=>{const i=t.getIndexDefinition();return i?i.defaultName(this.getDefaultIndexName(t.getName())).get():null})).filter((t=>null!=t))];let n="";return i.encoding&&(n+=` DEFAULT CHARACTER SET ${i.encoding}`),i.collation&&(n+=` DEFAULT COLLATE ${i.collation}`),`CREATE TABLE \`${this.name}\` (${e.join(", ")})${n};`}getAlterTableQuery(t,i){const e=[...t.map((t=>`ADD COLUMN ${t.getColumnDefinition().get()}`)),...t.map((t=>{const i=t.getIndexDefinition();return i?(i.defaultName(this.getDefaultIndexName(t.getName())),`ADD ${i.get()}`):null})).filter((t=>null!=t)),...i.map((t=>t.getModificationDefinition()))];return 0===e.length?null:`ALTER TABLE \`${this.name}\` ${e.join(", ")};`}}class R{constructor(t,i){this.connection=t,this.operations=i}create(t,i){return new B(t,this.connection,this.operations,!1,i)}table(t){return new B(t,this.connection,this.operations,!0)}}var S=function(t,i,e,n){return new(e||(e=Promise))((function(o,s){function a(t){try{r(n.next(t))}catch(t){s(t)}}function l(t){try{r(n.throw(t))}catch(t){s(t)}}function r(t){var i;t.done?o(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(a,l)}r((n=n.apply(t,i||[])).next())}))};class z{constructor(t){this.operations=[],this.connections=t}database(t,i){let e;if(i)e=this.connections.get(i);else{const i=this.connections.getAllByDatabaseName(t);if(0===i.length)throw new Error(`No connections found for database "${t}"`);if(i.length>1)throw new Error(`Multiple connections found for database "${t}". Connection name must be specified.`);e=i[0]}return this.operations.push((()=>S(this,void 0,void 0,(function*(){yield e.query(`CREATE DATABASE IF NOT EXISTS ${yield e.escape(t)};`)})))),this.operations.push((()=>S(this,void 0,void 0,(function*(){yield e.query(`USE ${yield e.escape(t)};`)})))),new R(e,this.operations)}executePendingOperations(){return S(this,void 0,void 0,(function*(){for(;this.operations.length>0;){const t=this.operations.shift();yield t()}}))}}var Y=o.ln,_=o.YB,j=o.HB,X=o.z4,K=o.RD;export{Y as AbstractMigration,_ as BlobColumnTypeEnum,j as IntColumnTypeEnum,X as MySql,K as StringColumnTypeEnum};
//# sourceMappingURL=index.mjs.map