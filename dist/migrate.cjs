(()=>{var t,e,n={91:(t,e,n)=>{"use strict";n.r(e);var i=n(324),o=n(722),a=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};jest.mock("../Utility/Modules");class r{constructor(){this.up=()=>"test",this.down=()=>"test"}}class s extends o.AbstractMigrateCommand{execute(){return a(this,void 0,void 0,(function*(){}))}getMigrationClassInstance(t){const e=Object.create(null,{getMigrationClassInstance:{get:()=>super.getMigrationClassInstance}});return a(this,void 0,void 0,(function*(){return e.getMigrationClassInstance.call(this,t)}))}}describe("AbstractMigrateCommand",(()=>{describe("getMigrationClassInstance",(()=>{it("correctly returns a named export",(()=>a(void 0,void 0,void 0,(function*(){i.j.import.mockResolvedValue({MockMigration:r});const t=new s,e=yield t.getMigrationClassInstance({name:"2023_01_01_103054_MockMigration",filepath:"path/to/migration",group:"test",groupDisplayName:"Test",executed:null,batch:1});expect(e).toBeInstanceOf(r)})))),it("correctly returns a default export",(()=>a(void 0,void 0,void 0,(function*(){i.j.import.mockResolvedValue({default:r});const t=new s,e=yield t.getMigrationClassInstance({name:"2023_01_01_103054_MockMigration",filepath:"path/to/migration",group:"test",groupDisplayName:"Test",executed:null,batch:1});expect(e).toBeInstanceOf(r)})))),it("throws an error if there are no matching exports found",(()=>a(void 0,void 0,void 0,(function*(){i.j.import.mockResolvedValue({});const t={name:"2023_01_01_103054_MockMigration",filepath:"path/to/migration",group:"test",groupDisplayName:"Test",executed:null,batch:1},e=new s;yield expect(e.getMigrationClassInstance(t)).rejects.toThrow(`Could not find migration class in ${t.filepath}`)}))))}))}))},722:(t,e,n)=>{"use strict";n.r(e),n.d(e,{AbstractMigrateCommand:()=>o}),n(324);const i=n(17);class o{getMigrationClassInstance(t){return e=this,o=void 0,r=function*(){return n(761)(`${i.relative(__dirname,t.filepath)}`)},new((a=void 0)||(a=Promise))((function(t,n){function i(t){try{l(r.next(t))}catch(t){n(t)}}function s(t){try{l(r.throw(t))}catch(t){n(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof a?n:new a((function(t){t(n)}))).then(i,s)}l((r=r.apply(e,o||[])).next())}));var e,o,a,r}}},598:(t,e,n)=>{"use strict";n.r(e)},957:(t,e,n)=>{"use strict";n.r(e);var i=n(611),o=n(472),a=n(22),r=n.n(a),s=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};jest.mock("../../DI/Container"),jest.mock("../../Utility/Modules"),jest.mock("../../Migration/Database/MySql");class l{constructor(){this.up=jest.fn(),this.down=jest.fn()}}console.log=jest.fn(),describe("RollbackCommand",(()=>{describe("execute",(()=>{beforeEach((()=>{i.W.getConfig.mockReturnValue({}),i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),remove:jest.fn(),getLatestBatch:jest.fn(),getAllByBatch:jest.fn()})})})),it("rolls back all migrations in the latest batch",(()=>s(void 0,void 0,void 0,(function*(){i.W.getMigrationDb().getMigrationRepository().getLatestBatch.mockReturnValue(1),i.W.getMigrationDb().getMigrationRepository().getAllByBatch.mockReturnValue([]);const t=new l,e=new o.RollbackCommand;e.getMigrationsToRollBack=jest.fn().mockResolvedValue([{migrationRow:{id:2,group:"group1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1}},{migrationRow:{id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1}}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),yield e.execute(),expect(t.down).toHaveBeenCalledTimes(2),expect(i.W.getMigrationDb().getMigrationRepository().remove).toHaveBeenCalledWith({id:2,group:"group1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"}),expect(i.W.getMigrationDb().getMigrationRepository().remove).toHaveBeenCalledWith({id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"}),expect(console.log).toHaveBeenCalledWith(r().greenBright("Successfully rolled back 2 migrations"))})))),it("logs correct message when migrations successfully run",(()=>s(void 0,void 0,void 0,(function*(){i.W.getMigrationDb().getMigrationRepository().getLatestBatch.mockReturnValue(1),i.W.getMigrationDb().getMigrationRepository().getAllByBatch.mockReturnValue([]);const t=new l,e=new o.RollbackCommand;e.getMigrationsToRollBack=jest.fn().mockResolvedValue([{migrationRow:{id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1}}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),yield e.execute(),expect(t.down).toHaveBeenCalledTimes(1),expect(i.W.getMigrationDb().getMigrationRepository().remove).toHaveBeenCalledWith({id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"}),expect(console.log).toHaveBeenCalledWith(r().greenBright("Successfully rolled back 1 migration"))})))),it("logs an error if a migration fails to roll back",(()=>s(void 0,void 0,void 0,(function*(){i.W.getConfig.mockReturnValue({}),i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),remove:jest.fn(),getLatestBatch:jest.fn().mockReturnValue(1),getAllByBatch:jest.fn().mockReturnValue([])})});const t=new l;t.down=jest.fn().mockRejectedValue(new Error("Something went wrong"));const e=new o.RollbackCommand;e.getMigrationsToRollBack=jest.fn().mockResolvedValue([{migrationRow:{id:2,group:"group1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1}}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),yield e.execute(),expect(t.down).toHaveBeenCalledTimes(1),expect(console.log).toHaveBeenCalledWith(r().redBright("Failed to roll back migrations: Something went wrong"))}))))})),describe("getMigrationsToRollBack",(()=>{beforeEach((()=>{i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),remove:jest.fn(),getLatestBatch:jest.fn().mockReturnValue(1),getAllByBatch:jest.fn().mockReturnValue([{id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},{id:2,group:"group1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},{id:3,group:"group1",name:"2023_12_12_100000_Migration3",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"}])})})})),afterEach((()=>{jest.clearAllMocks()})),it("returns an empty array if no latest batch is found",(()=>s(void 0,void 0,void 0,(function*(){i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({getLatestBatch:jest.fn().mockReturnValue(null)})});const t=new o.RollbackCommand,e=yield t.getMigrationsToRollBack();expect(e).toEqual([])})))),it("returns an array of files and rows in the correct order",(()=>s(void 0,void 0,void 0,(function*(){i.W.getProjectMigrations.mockResolvedValue({group1:[{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1},{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1},{filepath:"path/to/migration3",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_100000_Migration3",executed:"2023-12-12 11:08:11",batch:1}]});const t=new o.RollbackCommand,e=yield t.getMigrationsToRollBack();expect(e).toEqual([{migrationRow:{id:2,group:"group1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration2",executed:"2023-12-12 11:08:11",batch:1}},{migrationRow:{id:1,group:"group1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1}},{migrationRow:{id:3,group:"group1",name:"2023_12_12_100000_Migration3",executed:"2023-12-12 11:08:11",batch:1,created:"2023-12-12 11:08:11",updated:"2023-12-12 11:08:11"},migrationFile:{filepath:"path/to/migration3",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_100000_Migration3",executed:"2023-12-12 11:08:11",batch:1}}])})))),it("throws an error if a migration file cannot be found for a migration row",(()=>s(void 0,void 0,void 0,(function*(){i.W.getProjectMigrations.mockResolvedValue({group1:[{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_12_110000_Migration1",executed:"2023-12-12 11:08:11",batch:1}]});const t=(new o.RollbackCommand).getMigrationsToRollBack();yield expect(t).rejects.toThrow("Could not find migration file for 2023_12_12_110000_Migration2 in group group1")}))))}))}))},472:(t,e,n)=>{"use strict";n.r(e),n.d(e,{RollbackCommand:()=>u});var i=n(722),o=n(611),a=n(22),r=n.n(a),s=n(599),l=n(666),c=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class u extends i.AbstractMigrateCommand{execute(){return c(this,void 0,void 0,(function*(){const t=o.W.getConfig(),e=new s.T(t.connections),n=new l.z(e);let i=0;const a=yield this.getMigrationsToRollBack();if(a.length){try{for(const{migrationRow:t,migrationFile:e}of a){const a=yield this.getMigrationClassInstance(e);yield a.down(n),yield n.executePendingOperations(),yield o.W.getMigrationDb().getMigrationRepository().remove(t),i++}console.log(r().greenBright(`Successfully rolled back ${i} migration${1!==i?"s":""}`))}catch(t){console.log(r().redBright(`Failed to roll back migrations: ${t.message}`)),console.log(r().redBright(t.stack))}yield e.destroyAllInitialised()}else console.log(r().blueBright("No migrations to rollback"))}))}getMigrationsToRollBack(){return c(this,void 0,void 0,(function*(){const t=yield o.W.getMigrationDb().getMigrationRepository().getLatestBatch();if(!t)return[];const e=yield o.W.getMigrationDb().getMigrationRepository().getAllByBatch(t),n=yield o.W.getProjectMigrations();return Object.values(e).sort(((t,e)=>t.name<e.name?1:-1)).map((t=>{const e=n[t.group].find((e=>e.name===t.name));if(!e)throw new Error(`Could not find migration file for ${t.name} in group ${t.group}`);return{migrationRow:t,migrationFile:e}}))}))}}},882:(t,e,n)=>{"use strict";n.r(e);var i=n(611),o=n(578),a=n(324),r=n(22),s=n.n(r),l=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};jest.mock("../../DI/Container"),jest.mock("../../Migration/Database/Connections"),jest.mock("../../Migration/Database/MySql"),jest.mock("../../Utility/Modules"),console.log=jest.fn();class c{constructor(){this.up=jest.fn(),this.down=jest.fn()}}describe("RunCommand",(()=>{describe("execute",(()=>{beforeEach((()=>{i.W.getConfig.mockReturnValue({}),i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),getLatestBatch:jest.fn().mockReturnValue(null)})})})),afterEach((()=>{jest.clearAllMocks()})),it("correctly runs multiple migrations",(()=>l(void 0,void 0,void 0,(function*(){const t=new c,e=new o.RunCommand;e.getMigrationFilesToRun=jest.fn().mockResolvedValue([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null},{filepath:"path/to/migration3",group:"group2",groupDisplayName:"Group 2",name:"2023_12_11_110954_Migration2",executed:null,batch:null},{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110854_Migration2",executed:null,batch:null}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),a.j.import.mockResolvedValue({Migration1:c,Migration2:c}),yield e.execute(),expect(t.up).toHaveBeenCalledTimes(3),expect(i.W.getMigrationDb().getMigrationRepository().save).toHaveBeenCalledTimes(3),expect(console.log).toHaveBeenCalledWith(s().greenBright("Successfully ran 3 migrations"))})))),it("correctly runs a single migration",(()=>l(void 0,void 0,void 0,(function*(){const t=new c,e=new o.RunCommand;e.getMigrationFilesToRun=jest.fn().mockResolvedValue([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),a.j.import.mockResolvedValue({Migration1:c}),yield e.execute(),expect(t.up).toHaveBeenCalledTimes(1),expect(i.W.getMigrationDb().getMigrationRepository().save).toHaveBeenCalledTimes(1),expect(console.log).toHaveBeenCalledWith(s().greenBright("Successfully ran 1 migration"))})))),it("logs an error if a migration fails",(()=>l(void 0,void 0,void 0,(function*(){const t=new c;t.up=jest.fn().mockRejectedValue(new Error("Migration failed"));const e=new o.RunCommand;e.getMigrationFilesToRun=jest.fn().mockResolvedValue([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),i.W.getConfig.mockReturnValue({}),i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),getLatestBatch:jest.fn().mockReturnValue(null)})}),a.j.import.mockResolvedValue({Migration1:c}),yield e.execute(),expect(t.up).toHaveBeenCalledTimes(1),expect(i.W.getMigrationDb().getMigrationRepository().save).toHaveBeenCalledTimes(0),expect(console.log).toHaveBeenCalledWith(s().redBright("Failed to run migrations: Migration failed"))})))),it("logs correct error if a migration fails, rollback on error is set and there is nothing to roll back",(()=>l(void 0,void 0,void 0,(function*(){const t=new c;t.up=jest.fn().mockRejectedValue(new Error("Migration failed"));const e=new o.RunCommand({rollbackOnError:!0});e.getMigrationFilesToRun=jest.fn().mockResolvedValue([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null}]),e.getMigrationClassInstance=jest.fn().mockResolvedValue(t),a.j.import.mockResolvedValue({Migration1:c}),yield e.execute(),expect(t.up).toHaveBeenCalledTimes(1),expect(i.W.getMigrationDb().getMigrationRepository().save).toHaveBeenCalledTimes(0),expect(console.log).toHaveBeenNthCalledWith(1,s().redBright("Failed to run migrations: Migration failed")),expect(console.log).toHaveBeenNthCalledWith(4,s().yellowBright("Nothing to roll back - 0 migrations finished successfully."))})))),it("logs correct message if a migration fails, rollback on error is set and there is something to roll back",(()=>l(void 0,void 0,void 0,(function*(){const t=new c;let e=!0;t.up=jest.fn().mockImplementation((()=>l(void 0,void 0,void 0,(function*(){if(!e)throw new Error("Migration failed");e=!1}))));const n=new o.RunCommand({rollbackOnError:!0});n.getMigrationFilesToRun=jest.fn().mockResolvedValue([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null},{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration2",executed:null,batch:null}]),n.getMigrationClassInstance=jest.fn().mockResolvedValue(t),i.W.getConfig.mockReturnValue({}),i.W.getMigrationDb.mockReturnValue({getMigrationRepository:jest.fn().mockReturnValue({save:jest.fn(),getLatestBatch:jest.fn().mockReturnValue(1),getAllByBatch:jest.fn().mockResolvedValue([])})}),a.j.import.mockResolvedValue({Migration1:c}),yield n.execute(),expect(t.up).toHaveBeenCalledTimes(2),expect(i.W.getMigrationDb().getMigrationRepository().save).toHaveBeenCalledTimes(1),expect(console.log).toHaveBeenNthCalledWith(1,s().redBright("Failed to run migrations: Migration failed")),expect(console.log).toHaveBeenNthCalledWith(4,s().yellowBright("Attempting to roll back migrations..."))}))))})),describe("getMigrationFilesToRun",(()=>{it("resolves an array of migration files in the correct order",(()=>l(void 0,void 0,void 0,(function*(){i.W.getProjectMigrations.mockResolvedValue({group1:[{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null},{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110854_Migration2",executed:null,batch:null}],group2:[{filepath:"path/to/migration3",group:"group2",groupDisplayName:"Group 2",name:"2023_12_11_110711_Migration1",executed:null,batch:null}]});const t=new o.RunCommand,e=yield t.getMigrationFilesToRun();expect(e).toEqual([{filepath:"path/to/migration1",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110710_Migration1",executed:null,batch:null},{filepath:"path/to/migration3",group:"group2",groupDisplayName:"Group 2",name:"2023_12_11_110711_Migration1",executed:null,batch:null},{filepath:"path/to/migration2",group:"group1",groupDisplayName:"Group 1",name:"2023_12_11_110854_Migration2",executed:null,batch:null}])}))))}))}))},578:(t,e,n)=>{"use strict";n.r(e),n.d(e,{RunCommand:()=>g});var i=n(722),o=n(611),a=n(599),r=n(666),s=n(558),l=n(748),c=n(22),u=n.n(c),d=n(472),h=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class g extends i.AbstractMigrateCommand{constructor(t){super(),this.options=t}execute(){var t;return h(this,void 0,void 0,(function*(){let e=0;const n=o.W.getConfig(),i=new a.T(n.connections),c=new r.z(i),h=yield this.getMigrationFilesToRun(),g=o.W.getMigrationDb().getMigrationRepository(),p=yield g.getLatestBatch(),m=p?p+1:1;try{for(const t of h){const n=yield this.getMigrationClassInstance(t);yield n.up(c),yield c.executePendingOperations();const i=new s.U;i.name=t.name,i.group=t.group,i.executed=l.DateTime.now().toSQL({includeOffset:!1}),i.batch=m,yield g.save(i),e++}console.log(u().greenBright(`Successfully ran ${e} migration${1!==e?"s":""}`))}catch(n){console.log(u().redBright(`Failed to run migrations: ${n.message}`)),console.log(u().redBright(n.stack)),!0===(null===(t=this.options)||void 0===t?void 0:t.rollbackOnError)&&(e>0?(console.log(""),console.log(u().yellowBright("Attempting to roll back migrations...")),yield(new d.RollbackCommand).execute()):(console.log(""),console.log(u().yellowBright("Nothing to roll back - 0 migrations finished successfully."))))}yield i.destroyAllInitialised()}))}getMigrationFilesToRun(){return h(this,void 0,void 0,(function*(){const t=yield o.W.getProjectMigrations({includeExecuted:!1}),e=[];for(const n in t)e.push(...t[n]);return e.sort(((t,e)=>t.name<e.name?-1:1)),e}))}}},432:(t,e,n)=>{"use strict";n.r(e);var i=n(611),o=n(276),a=n(22),r=n.n(a),s=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};console.log=jest.fn(),jest.mock("../../DI/Container"),describe("StatusCommand",(()=>{describe("execute",(()=>{it('logs "No migrations found" if there are no migrations',(()=>s(void 0,void 0,void 0,(function*(){i.W.getConfig.mockReturnValue({migrationDirs:{group1:{name:"Group 1"}}}),i.W.getProjectMigrations.mockResolvedValue({group1:[]}),yield(new o.StatusCommand).execute(),expect(console.log).toHaveBeenCalledWith(r().yellowBright("Group 1")),expect(console.log).toHaveBeenCalledWith(r().redBright("  * No migrations found *"))})))),it("logs migration names, marking executed ones in green and non-executed in red",(()=>s(void 0,void 0,void 0,(function*(){i.W.getConfig.mockReturnValue({migrationDirs:{group1:{name:"Group 1"}}}),i.W.getProjectMigrations.mockResolvedValue({group1:[{name:"Migration1",executed:"2023-01-31 12:00:00"},{name:"Migration2",executed:null}]}),yield(new o.StatusCommand).execute(),expect(console.log).toHaveBeenCalledWith(r().yellowBright("Group 1")),expect(console.log).toHaveBeenCalledWith(`  ${r().greenBright("Migration1")}`),expect(console.log).toHaveBeenCalledWith(`  ${r().redBright("Migration2")}`)}))))}))}))},276:(t,e,n)=>{"use strict";n.r(e),n.d(e,{StatusCommand:()=>s});var i=n(722),o=n(611),a=n(22),r=n.n(a);class s extends i.AbstractMigrateCommand{execute(){return t=this,e=void 0,i=function*(){const t=o.W.getConfig().migrationDirs,e=yield o.W.getProjectMigrations();for(const n in e){const i=e[n],{name:o}=t[n];if(console.log(r().yellowBright(o)),0!==i.length)for(const t of i)console.log(`  ${t.executed?r().greenBright(t.name):r().redBright(t.name)}`);else console.log(r().redBright("  * No migrations found *"))}},new((n=void 0)||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}}},611:(t,e,n)=>{"use strict";n.d(e,{W:()=>R});var i=n(818),o=n(250),a=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class r{constructor(t){this.dataSource=new o.DataSource(t)}initialize(){return a(this,void 0,void 0,(function*(){yield this.dataSource.initialize()}))}destroy(){return a(this,void 0,void 0,(function*(){yield this.dataSource.destroy()}))}}class s{constructor(t){this.entityManager=t}}var l=function(t,e,n,i){var o,a=arguments.length,r=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(r=(a<3?o(r):a>3?o(e,n,r):o(e,n))||r);return a>3&&r&&Object.defineProperty(e,n,r),r},c=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let u=class{constructor(){this.id=null,this.group=null,this.name=null,this.executed=null,this.batch=null,this.created=null,this.updated=null}};l([(0,o.PrimaryGeneratedColumn)(),c("design:type",Number)],u.prototype,"id",void 0),l([(0,o.Column)(),c("design:type",String)],u.prototype,"group",void 0),l([(0,o.Column)(),c("design:type",String)],u.prototype,"name",void 0),l([(0,o.Column)(),c("design:type",String)],u.prototype,"executed",void 0),l([(0,o.Column)(),c("design:type",Number)],u.prototype,"batch",void 0),l([(0,o.Column)(),c("design:type",String)],u.prototype,"created",void 0),l([(0,o.Column)(),c("design:type",String)],u.prototype,"updated",void 0),u=l([(0,o.Entity)("migration")],u);var d=n(558),h=n(748),g=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class p extends s{getAll(){return g(this,void 0,void 0,(function*(){return this.toEntityMap(yield this.entityManager.find(u))}))}getById(t){return g(this,void 0,void 0,(function*(){return this.toEntity(yield this.entityManager.findOneBy(u,{id:t}))}))}getLatestBatch(){return g(this,void 0,void 0,(function*(){const t=yield this.entityManager.createQueryBuilder(u,"migration").select("MAX(migration.batch)","maxBatch").getRawOne();return t&&t.maxBatch?parseInt(t.maxBatch):null}))}getAllByBatch(t){return g(this,void 0,void 0,(function*(){return this.toEntityMap(yield this.entityManager.createQueryBuilder(u,"m").where("m.batch = :batch",{batch:t}).orderBy("executed","DESC").getMany())}))}remove(...t){return g(this,void 0,void 0,(function*(){yield this.entityManager.remove(t.map((t=>this.toModel(t))))}))}save(...t){return g(this,void 0,void 0,(function*(){yield this.entityManager.save(t.map((t=>{const e=h.DateTime.now().toSQL({includeOffset:!1});return t.id||(t.created=e),t.updated=e,this.toModel(t)})))}))}toEntityMap(t){const e={};return t.forEach((t=>{e[t.id]=this.toEntity(t)})),e}toEntity(t){return i.Objects.hydrate(new d.U,t)}toModel(t){return i.Objects.hydrate(new u,t)}getModel(){return u}}var m=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class f extends r{constructor(t){super({type:"mysql",database:t.database,host:t.host,port:t.port,username:t.username,password:t.password,entities:[u]})}transaction(t){return m(this,void 0,void 0,(function*(){yield this.dataSource.transaction((e=>m(this,void 0,void 0,(function*(){const n={migration:new p(e)};return t(n)}))))}))}getMigrationRepository(){return new p(this.dataSource.manager)}}var v=n(17),y=n.n(v);const b=require("fs");var M=n.n(b),x=n(324),w=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class R{static ensureMigrationDbExists(){return w(this,void 0,void 0,(function*(){const t=this.getMigrationDbConnectionOptions(),e=new o.DataSource({type:"mysql",host:t.host,port:t.port,username:t.username,password:t.password});yield e.initialize();const n=e.createQueryRunner();yield n.connect(),yield n.query(`CREATE DATABASE IF NOT EXISTS ${t.database};`),yield n.query(`USE ${t.database}`),yield n.query("\n      CREATE TABLE IF NOT EXISTS migration (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        `group` VARCHAR(255) NOT NULL,\n        name VARCHAR(255) NOT NULL,\n        executed DATETIME NOT NULL,\n        batch INT NOT NULL,\n        created DATETIME NOT NULL,\n        updated DATETIME NOT NULL\n      ) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\n      "),yield n.release(),yield e.destroy()}))}static getMigrationDb(){return this.migrationDb||(this.migrationDb=new f(this.getMigrationDbConnectionOptions())),this.migrationDb}static loadConfig(){return w(this,void 0,void 0,(function*(){try{this.config=yield x.j.import("default",y().join(process.cwd(),"migrate.config.js"))}catch(t){throw new Error(`Failed to read migrate.config.js file: ${t.message}`)}const{valid:t,message:e}=i.Validators.schema({migrationDatabase:i.Validators.string(),connections:i.Validators.object(i.Validators.schema({host:i.Validators.string(),port:i.Validators.integer(),username:i.Validators.string(),password:i.Validators.string(),databases:i.Validators.array(i.Validators.string())})),migrationDirs:i.Validators.object(i.Validators.schema({name:i.Validators.string(),path:i.Validators.string()}))}).validate(this.config);if(!t)throw new Error(`Invalid migrate.config.js file: ${e}`);return this.config}))}static getConfig(){if(!this.config)throw new Error("Config not loaded");return this.config}static getProjectMigrations(t){return w(this,void 0,void 0,(function*(){const e={},n=this.getConfig().migrationDirs,o=yield this.getMigrationDb().getMigrationRepository().getAll(),a={};for(const r in n){e[r]=[];const{name:s,path:l}=n[r];let c;const u=y().join(process.cwd(),l);try{c=yield M().promises.readdir(u)}catch(t){throw new Error(`Failed to read migration directory ${l}: ${t.message}`)}for(const n of c){const[l]=n.split("."),{valid:c,message:d}=i.Validators.regex(/^(19|20)\d{2}_(0[1-9]|1[0-2])_(0[1-9]|[12][0-9]|3[01])_([0-1][0-9]|2[0-3])([0-5][0-9]){2}_[A-Za-z][A-Za-z0-9_]*$/,"YYYY_MM_DD_HHMMSS_MigrationName").validate(l);if(!c)throw new Error(`Invalid migration file name: ${d}`);const[h,g,p,m]=l.split("_"),f=`${h}_${g}_${p}_${m}`;if(a[f])throw new Error(`Duplicate migration timestamp "${f}" found in ${a[f]} and ${n}`);a[f]=n;const v=Object.values(o).find((t=>t.name===l));if(!1===(null==t?void 0:t.includeExecuted)&&(null==v?void 0:v.executed))continue;const y={filepath:`${u}/${n}`,group:r,groupDisplayName:s,name:l,executed:(null==v?void 0:v.executed)||null,batch:(null==v?void 0:v.batch)||null};e[r].push(y)}}return e}))}static getMigrationDbConnectionOptions(){const t=this.getConfig(),{migrationDatabase:e}=t;let n;for(const i in t.connections)if(t.connections[i].databases.includes(e)){if(n)throw new Error(`Multiple connections found for migration database "${e}"`);n=t.connections[i]}if(!n)throw new Error(`Cannot connect to migration database - no connection found for database "${e}"`);return{database:e,host:n.host,port:n.port,username:n.username,password:n.password}}}},558:(t,e,n)=>{"use strict";n.d(e,{U:()=>i});class i{constructor(){this.id=null,this.group=null,this.name=null,this.executed=null,this.batch=null,this.created=null,this.updated=null}}},599:(t,e,n)=>{"use strict";n.d(e,{T:()=>r});var i=n(250),o=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class a{constructor(t){this.connectionConfig=t}query(t,e=[]){return o(this,void 0,void 0,(function*(){return(yield this.get()).query(t,e)}))}destroy(){return o(this,void 0,void 0,(function*(){this.connection&&(yield this.connection.destroy(),this.connection=void 0)}))}isInitialised(){return!!this.connection}escape(t){return o(this,void 0,void 0,(function*(){return(yield this.get()).driver.escape(t)}))}get(){return o(this,void 0,void 0,(function*(){return this.connection||(this.connection=new i.DataSource({type:"mysql",host:this.connectionConfig.host,port:this.connectionConfig.port,username:this.connectionConfig.username,password:this.connectionConfig.password}),yield this.connection.initialize()),this.connection}))}}class r{constructor(t){this.config={},this.connections={},this.config=t}get(t){if(this.connections[t])return this.connections[t];if(!this.config[t])throw new Error(`Config for connection "${t}" not found`);const{host:e,port:n,username:i,password:o}=this.config[t];return this.connections[t]=new a({host:e,port:n,username:i,password:o}),this.connections[t]}getAllByDatabaseName(t){const e=[];for(const n in this.config)this.config[n].databases.includes(t)&&e.push(this.get(n));return e}destroyAllInitialised(){return t=this,e=void 0,i=function*(){const t=this.getAllInitialised();for(const e of t)yield e.destroy()},new((n=void 0)||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}getAllInitialised(){return Object.values(this.connections).filter((t=>t.isInitialised()))}}},666:(t,e,n)=>{"use strict";var i;n.d(e,{z:()=>R}),function(t){t.INT="INT",t.TINYINT="TINYINT",t.SMALLINT="SMALLINT",t.MEDIUMINT="MEDIUMINT",t.BIGINT="BIGINT"}(i||(i={}));var o=n(818),a=n(22),r=n.n(a);class s{validateName(t){const{valid:e,message:n}=o.Validators.all([o.Validators.string(),o.Validators.minLength(1),o.Validators.regex(/^[a-zA-Z_][a-zA-Z0-9_]{0,63}$/,"A-z, 0-9 and/or _")]).validate(t);if(!e)throw new TypeError(`Invalid ${this.constructor.name} name: ${n}`);return!0}validateOptions(t,e){const{valid:n,message:i}=o.Validators.schema(e).validate(t);if(!n)throw new TypeError(`Invalid ${this.constructor.name} options. ${i}`);return!0}addNullableStatement(t,e){return e?`${t} NULL`:`${t} NOT NULL`}addDefaultStatement(t,e){return void 0!==e?`${t} DEFAULT ${e}`:t}addIndexStatement(t,e){return e?`${t} INDEX`:t}addUnsignedStatement(t,e){return e?`${t} UNSIGNED`:t}addZeroFillStatement(t,e){return e?`${t} ZEROFILL`:t}addAutoIncrementStatement(t,e){return e?`${t} AUTO_INCREMENT`:t}addPrimaryKeyStatement(t,e){return e?`${t} PRIMARY KEY`:t}addAfterStatement(t,e,n){return!n&&e&&console.warn(r().yellowBright("WARNING: addAfter option is ignored when creating a new table.")),n?(e&&(t+=` AFTER ${e}`),t):t}}class l extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({type:i.INT,nullable:!1,default:void 0,unsigned:!1,autoIncrement:!1,zeroFill:!1,primaryKey:!1,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:o.Validators.enumValue(i),nullable:o.Validators.boolean(),default:o.Validators.integer({optional:!0}),unsigned:o.Validators.boolean(),autoIncrement:o.Validators.boolean(),zeroFill:o.Validators.boolean(),primaryKey:o.Validators.boolean(),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} ${this.options.type}`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,this.options.default),a=this.addUnsignedStatement(a,this.options.unsigned),a=this.addAutoIncrementStatement(a,this.options.autoIncrement),a=this.addZeroFillStatement(a,this.options.zeroFill),a=this.addPrimaryKeyStatement(a,this.options.primaryKey),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}class c extends l{constructor(t){super(t,{type:i.INT,nullable:!1,default:void 0,unsigned:!1,autoIncrement:!0,zeroFill:!1,primaryKey:!0,index:!1})}}var u;class d extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,unsigned:!1,zeroFill:!1,precision:10,scale:2,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:o.Validators.boolean(),default:o.Validators.number({optional:!0}),unsigned:o.Validators.boolean(),zeroFill:o.Validators.boolean(),precision:o.Validators.integer(),scale:o.Validators.integer(),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} DECIMAL(${this.options.precision}, ${this.options.scale})`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,"number"==typeof this.options.default?this.options.default.toFixed(this.options.scale):void 0),a=this.addUnsignedStatement(a,this.options.unsigned),a=this.addZeroFillStatement(a,this.options.zeroFill),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}!function(t){t.CHAR="CHAR",t.VARCHAR="VARCHAR",t.TEXT="TEXT",t.TINYTEXT="TINYTEXT",t.MEDIUMTEXT="MEDIUMTEXT",t.LONGTEXT="LONGTEXT"}(u||(u={}));class h extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name);const n=(null==e?void 0:e.type)||u.VARCHAR;this.options=Object.assign({type:n,nullable:!1,primaryKey:!1,default:void 0,length:n!==u.VARCHAR?void 0:255,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:o.Validators.enumValue(u),nullable:o.Validators.boolean(),primaryKey:o.Validators.boolean(),default:o.Validators.string({optional:!0}),length:o.Validators.integer({optional:!0}),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} ${this.options.type}`;this.options.type!==u.CHAR&&this.options.type!==u.VARCHAR||void 0!==this.options.length&&(a+=`(${this.options.length})`),a=this.addNullableStatement(a,this.options.nullable),a=this.addPrimaryKeyStatement(a,this.options.primaryKey),a=this.addDefaultStatement(a,this.options.default?`'${this.options.default}'`:void 0),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}class g extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:o.Validators.boolean(),default:o.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,"YYYY-MM-DD",{optional:!0}),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} DATE`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,this.options.default?`'${this.options.default}'`:void 0),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}class p extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,addAfter:void 0},e),this.validateOptions(this.options,{nullable:o.Validators.boolean(),default:o.Validators.regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"HH:MM:SS",{optional:!0}),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} TIME`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,this.options.default?`'${this.options.default}'`:void 0),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}var m;class f extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},e),this.validateOptions(this.options,{nullable:o.Validators.boolean(),default:o.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]) ([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"YYYY-MM-DD HH:MM:SS",{optional:!0}),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} DATETIME`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,this.options.default?`'${this.options.default}'`:void 0),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}!function(t){t.BLOB="BLOB",t.TINYBLOB="TINYBLOB",t.MEDIUMBLOB="MEDIUMBLOB",t.LONGBLOB="LONGBLOB"}(m||(m={}));class v extends s{constructor(t,e){super(),this.name=t,this.validateName(this.name),this.options=Object.assign({type:m.BLOB,nullable:!1,addAfter:void 0},e),this.validateOptions(this.options,{type:o.Validators.enumValue(m),nullable:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} ${this.options.type}`;a=this.addNullableStatement(a,this.options.nullable),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}class y extends s{constructor(t,e,n){super(),this.name=t,this.validateName(this.name),this.values=e;const{valid:i,message:a}=o.Validators.all([o.Validators.array(o.Validators.all([o.Validators.string(),o.Validators.minLength(1)])),o.Validators.minLength(1)]).validate(this.values);if(!i)throw new TypeError(`Invalid ${this.constructor.name} values. ${a}`);this.options=Object.assign({nullable:!1,default:void 0,index:!1,addAfter:void 0},n);const r={};for(const t of this.values)r[t]=t;this.validateOptions(this.options,{nullable:o.Validators.boolean(),default:o.Validators.enumValue(r,{optional:!0}),index:o.Validators.boolean(),addAfter:o.Validators.string({optional:!0})})}create(t,e,n){return i=this,o=void 0,r=function*(){const i=yield t.escape(this.name),o=yield t.escape(e);let a=`${i} ENUM('${this.values.join("', '")}')`;a=this.addNullableStatement(a,this.options.nullable),a=this.addDefaultStatement(a,this.options.default?`'${this.options.default}'`:void 0),a=this.addIndexStatement(a,this.options.index),a=this.addAfterStatement(a,this.options.addAfter?yield t.escape(this.options.addAfter):void 0,!n),n?yield t.query(`CREATE TABLE ${o} (${a});`):yield t.query(`ALTER TABLE ${o} ADD COLUMN ${a};`)},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(n,s)}l((r=r.apply(i,o||[])).next())}));var i,o,a,r}}var b=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class M{constructor(t,e,n,i){this.operations=[],this.name=t,this.connection=e,this.operations=n,this.tableExists=i}id(t="id"){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const e=new c(t);yield e.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}int(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new l(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}decimal(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new d(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}string(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new h(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}enum(t,e,n){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const i=new y(t,e,n);yield i.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}date(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new g(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}time(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new p(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}datetime(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new f(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}blob(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){const n=new v(t,e);yield n.create(this.connection,this.name,!this.tableExists),this.tableExists=!0})))),this}renameColumn(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} RENAME COLUMN ${yield this.connection.escape(t)} TO ${yield this.connection.escape(e)};`)})))),this}dropColumn(t){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} DROP COLUMN ${yield this.connection.escape(t)};`)})))),this}addColumnIndex(t){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} ADD INDEX ${yield this.connection.escape(t)};`)})))),this}dropColumnIndex(t){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} DROP INDEX ${yield this.connection.escape(t)};`)})))),this}setColumnNullable(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} MODIFY COLUMN ${yield this.connection.escape(t)} ${e?"NULL":"NOT NULL"};`)})))),this}setColumnDefault(t,e){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`ALTER TABLE ${yield this.connection.escape(this.name)} MODIFY COLUMN ${yield this.connection.escape(t)} DEFAULT ${"string"==typeof e?`'${e}'`:e};`)})))),this}drop(){return this.operations.push((()=>b(this,void 0,void 0,(function*(){yield this.connection.query(`DROP TABLE ${yield this.connection.escape(this.name)};`)})))),this}}class x{constructor(t,e){this.connection=t,this.operations=e}create(t){return new M(t,this.connection,this.operations,!1)}table(t){return new M(t,this.connection,this.operations,!0)}}var w=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};class R{constructor(t){this.operations=[],this.connections=t}database(t,e){let n;if(e)n=this.connections.get(e);else{const e=this.connections.getAllByDatabaseName(t);if(0===e.length)throw new Error(`No connections found for database "${t}"`);if(e.length>1)throw new Error(`Multiple connections found for database "${t}". Connection name must be specified.`);n=e[0]}return this.operations.push((()=>w(this,void 0,void 0,(function*(){yield n.query(`CREATE DATABASE IF NOT EXISTS ${yield n.escape(t)};`)})))),this.operations.push((()=>w(this,void 0,void 0,(function*(){yield n.query(`USE ${yield n.escape(t)};`)})))),new x(n,this.operations)}executePendingOperations(){return w(this,void 0,void 0,(function*(){for(;this.operations.length>0;){const t=this.operations.shift();yield t()}}))}}},324:(t,e,n)=>{"use strict";n.d(e,{j:()=>i});class i{static import(...t){return e=this,n=void 0,o=function*(){const[e,n]=t,i=null!=n?e:null,o=null!=n?n:e,a=yield import(`${o}`);return i?a[i]:a},new((i=void 0)||(i=Promise))((function(t,a){function r(t){try{l(o.next(t))}catch(t){a(t)}}function s(t){try{l(o.throw(t))}catch(t){a(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,s)}l((o=o.apply(e,n||[])).next())}));var e,n,i,o}}},761:(t,e,n)=>{var i={"./AbstractMigrateCommand":722,"./AbstractMigrateCommand.test":91,"./AbstractMigrateCommand.test.ts":91,"./AbstractMigrateCommand.ts":722,"./MigrateCommandInterface":598,"./MigrateCommandInterface.ts":598,"./Rollback/RollbackCommand":472,"./Rollback/RollbackCommand.test":957,"./Rollback/RollbackCommand.test.ts":957,"./Rollback/RollbackCommand.ts":472,"./Run/RunCommand":578,"./Run/RunCommand.test":882,"./Run/RunCommand.test.ts":882,"./Run/RunCommand.ts":578,"./Status/StatusCommand":276,"./Status/StatusCommand.test":432,"./Status/StatusCommand.test.ts":432,"./Status/StatusCommand.ts":276};function o(t){var e=a(t);return n(e)}function a(t){if(!n.o(i,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return i[t]}o.keys=function(){return Object.keys(i)},o.resolve=a,t.exports=o,o.id=761},818:t=>{"use strict";t.exports=require("@electra/utility")},562:t=>{"use strict";t.exports=require("caporal")},22:t=>{"use strict";t.exports=require("chalk")},748:t=>{"use strict";t.exports=require("luxon")},250:t=>{"use strict";t.exports=require("typeorm")},17:t=>{"use strict";t.exports=require("path")},147:t=>{"use strict";t.exports={i8:"1.0.0"}}},i={};function o(t){var e=i[t];if(void 0!==e)return e.exports;var a=i[t]={exports:{}};return n[t](a,a.exports,o),a.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,o.t=function(n,i){if(1&i&&(n=this(n)),8&i)return n;if("object"==typeof n&&n){if(4&i&&n.__esModule)return n;if(16&i&&"function"==typeof n.then)return n}var a=Object.create(null);o.r(a);var r={};t=t||[null,e({}),e([]),e(e)];for(var s=2&i&&n;"object"==typeof s&&!~t.indexOf(s);s=e(s))Object.getOwnPropertyNames(s).forEach((t=>r[t]=()=>n[t]));return r.default=()=>n,o.d(a,r),a},o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var a={};(()=>{"use strict";o.r(a);var t=o(611),e=o(22),n=o.n(e);require("reflect-metadata");var i=o(276),r=o(578),s=o(472),l=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))};function c(e){return(n,i,o)=>l(this,void 0,void 0,(function*(){yield t.W.ensureMigrationDbExists(),yield t.W.getMigrationDb().initialize(),yield e(n,i,o),yield t.W.getMigrationDb().destroy()}))}l(void 0,void 0,void 0,(function*(){yield t.W.loadConfig();const{default:e}=yield Promise.resolve().then(o.t.bind(o,562,23));try{e.name("Electra Migrate").description("MySQL Migrations for Node.js Applications").version(o(147).i8),e.command("status","Show the status of all migrations").action(c((()=>l(void 0,void 0,void 0,(function*(){yield(new i.StatusCommand).execute()}))))),e.command("run","Run all migrations").option("--rollback-on-error","Automatically rollback migrations if an error occurs").action(c(((t,e)=>l(void 0,void 0,void 0,(function*(){const t=new r.RunCommand({rollbackOnError:e.rollbackOnError||!1});yield t.execute()}))))),e.command("rollback","Rollback the last batch of migrations").action(c((()=>l(void 0,void 0,void 0,(function*(){yield(new s.RollbackCommand).execute()}))))),e.parse(process.argv)}catch(t){console.log(n().redBright(t.stack))}}))})(),module.exports=a})();