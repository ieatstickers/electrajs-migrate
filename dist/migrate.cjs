(()=>{"use strict";var t,e,n={562:t=>{t.exports=require("caporal")},147:t=>{t.exports={i8:"1.0.0"}}},i={};function o(t){var e=i[t];if(void 0!==e)return e.exports;var s=i[t]={exports:{}};return n[t](s,s.exports,o),s.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,o.t=function(n,i){if(1&i&&(n=this(n)),8&i)return n;if("object"==typeof n&&n){if(4&i&&n.__esModule)return n;if(16&i&&"function"==typeof n.then)return n}var s=Object.create(null);o.r(s);var r={};t=t||[null,e({}),e([]),e(e)];for(var a=2&i&&n;"object"==typeof a&&!~t.indexOf(a);a=e(a))Object.getOwnPropertyNames(a).forEach((t=>r[t]=()=>n[t]));return r.default=()=>n,o.d(s,r),s},o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};(()=>{o.r(s);const t=require("@electra/utility"),e=require("typeorm");var n=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class i{constructor(t){this.dataSource=new e.DataSource(t)}initialize(){return n(this,void 0,void 0,(function*(){yield this.dataSource.initialize()}))}destroy(){return n(this,void 0,void 0,(function*(){yield this.dataSource.destroy()}))}}class r{constructor(t){this.entityManager=t}}var a=function(t,e,n,i){var o,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,n,r):o(e,n))||r);return s>3&&r&&Object.defineProperty(e,n,r),r},l=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let u=class{constructor(){this.id=null,this.group=null,this.name=null,this.executed=null,this.batch=null,this.created=null,this.updated=null}};a([(0,e.PrimaryGeneratedColumn)(),l("design:type",Number)],u.prototype,"id",void 0),a([(0,e.Column)(),l("design:type",String)],u.prototype,"group",void 0),a([(0,e.Column)(),l("design:type",String)],u.prototype,"name",void 0),a([(0,e.Column)(),l("design:type",String)],u.prototype,"executed",void 0),a([(0,e.Column)(),l("design:type",Number)],u.prototype,"batch",void 0),a([(0,e.Column)(),l("design:type",String)],u.prototype,"created",void 0),a([(0,e.Column)(),l("design:type",String)],u.prototype,"updated",void 0),u=a([(0,e.Entity)("migration")],u);class c{constructor(){this.id=null,this.group=null,this.name=null,this.executed=null,this.batch=null,this.created=null,this.updated=null}}const d=require("luxon");var h=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class p extends r{getAll(){return h(this,void 0,void 0,(function*(){return this.toEntityMap(yield this.entityManager.find(u))}))}getById(t){return h(this,void 0,void 0,(function*(){return this.toEntity(yield this.entityManager.findOneBy(u,{id:t}))}))}getLatestBatch(){return h(this,void 0,void 0,(function*(){const t=yield this.entityManager.createQueryBuilder(u,"migration").select("MAX(migration.batch)","maxBatch").getRawOne();return t&&t.maxBatch?parseInt(t.maxBatch):null}))}getAllByBatch(t){return h(this,void 0,void 0,(function*(){return this.toEntityMap(yield this.entityManager.createQueryBuilder(u,"m").where("m.batch = :batch",{batch:t}).orderBy("executed","DESC").getMany())}))}remove(...t){return h(this,void 0,void 0,(function*(){yield this.entityManager.remove(t.map((t=>this.toModel(t))))}))}save(...t){return h(this,void 0,void 0,(function*(){yield this.entityManager.save(t.map((t=>{const e=d.DateTime.now().toSQL({includeOffset:!1});return t.id||(t.created=e),t.updated=e,this.toModel(t)})))}))}toEntityMap(t){const e={};return t.forEach((t=>{e[t.id]=this.toEntity(t)})),e}toEntity(e){return t.Objects.hydrate(new c,e)}toModel(e){return t.Objects.hydrate(new u,e)}getModel(){return u}}var f=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class m extends i{constructor(t){super({type:"mysql",database:t.database,host:t.host,port:t.port,username:t.username,password:t.password,entities:[u]})}transaction(t){return f(this,void 0,void 0,(function*(){yield this.dataSource.transaction((e=>f(this,void 0,void 0,(function*(){const n={migration:new p(e)};return t(n)}))))}))}getMigrationRepository(){return new p(this.dataSource.manager)}}const g=require("path");var v=o.n(g);const y=require("fs");var w=o.n(y),x=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class D{static import(...t){return x(this,void 0,void 0,(function*(){const[e,n]=t,i=null!=n?e:null,o=null!=n?n:e,s=yield import(`${o}`);return i?s[i]:s}))}static require(...t){const[e,n]=t,i=null!=n?e:null,o=require(`${null!=n?n:e}`);return i?o[i]:o}static isCommonJS(){return x(this,void 0,void 0,(function*(){const t=`${process.cwd()}/package.json`;let e;try{e=JSON.parse(yield w().promises.readFile(t,{encoding:"utf-8"}))}catch(t){throw new Error("Command must be run from the root of your project containing a valid package.json file.")}return"module"!==e.type}))}}var E=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class I{static ensureMigrationDbExists(){return E(this,void 0,void 0,(function*(){const t=this.getMigrationDbConnectionOptions(),n=new e.DataSource({type:"mysql",host:t.host,port:t.port,username:t.username,password:t.password});yield n.initialize();const i=n.createQueryRunner();yield i.connect(),yield i.query(`CREATE DATABASE IF NOT EXISTS ${t.database};`),yield i.query(`USE ${t.database}`),yield i.query("\n      CREATE TABLE IF NOT EXISTS migration (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        `group` VARCHAR(255) NOT NULL,\n        name VARCHAR(255) NOT NULL,\n        executed DATETIME NOT NULL,\n        batch INT NOT NULL,\n        created DATETIME NOT NULL,\n        updated DATETIME NOT NULL\n      ) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\n      "),yield i.release(),yield n.destroy()}))}static getMigrationDb(){return this.migrationDb||(this.migrationDb=new m(this.getMigrationDbConnectionOptions())),this.migrationDb}static loadConfig(){return E(this,void 0,void 0,(function*(){let e;const n=global.process.env.NODE_ENV;if(n)try{e=yield D.import("default",v().join(process.cwd(),`migrate.config.${n}.js`))}catch(t){throw new Error(`Failed to read migrate.config.${n}.js file: ${t.message}`)}try{this.config=t.Objects.merge(yield D.import("default",v().join(process.cwd(),"migrate.config.js")),e||{})}catch(t){throw new Error(`Failed to read migrate.config.js file: ${t.message}`)}const{valid:i,message:o}=t.Validators.schema({migrationDatabase:t.Validators.string(),connections:t.Validators.object(t.Validators.schema({host:t.Validators.string(),port:t.Validators.integer(),username:t.Validators.string(),password:t.Validators.string(),databases:t.Validators.array(t.Validators.string())})),migrationDirs:t.Validators.object(t.Validators.schema({name:t.Validators.string(),path:t.Validators.string()}))}).validate(this.config);if(!i)throw new Error(`Invalid migrate.config.js file: ${o}`);return this.config}))}static getConfig(){if(!this.config)throw new Error("Config not loaded");return this.config}static getProjectMigrations(e){return E(this,void 0,void 0,(function*(){const n={},i=this.getConfig().migrationDirs,o=yield this.getMigrationDb().getMigrationRepository().getAll(),s={};for(const r in i){n[r]=[];const{name:a,path:l}=i[r];let u;const c=v().join(process.cwd(),l);try{u=yield w().promises.readdir(c)}catch(t){throw new Error(`Failed to read migration directory ${l}: ${t.message}`)}for(const i of u){const[l]=i.split("."),{valid:u,message:d}=t.Validators.regex(/^(19|20)\d{2}_(0[1-9]|1[0-2])_(0[1-9]|[12][0-9]|3[01])_([0-1][0-9]|2[0-3])([0-5][0-9]){2}_[A-Za-z][A-Za-z0-9_]*$/,"YYYY_MM_DD_HHMMSS_MigrationName").validate(l);if(!u)throw new Error(`Invalid migration file name: ${d}`);const[h,p,f,m]=l.split("_"),g=`${h}_${p}_${f}_${m}`;if(s[g])throw new Error(`Duplicate migration timestamp "${g}" found in ${s[g]} and ${i}`);s[g]=i;const v=Object.values(o).find((t=>t.name===l));if(!1===(null==e?void 0:e.includeExecuted)&&(null==v?void 0:v.executed))continue;const y={filepath:`${c}/${i}`,group:r,groupDisplayName:a,name:l,executed:(null==v?void 0:v.executed)||null,batch:(null==v?void 0:v.batch)||null};n[r].push(y)}}return n}))}static getMigrationDbConnectionOptions(){const t=this.getConfig(),{migrationDatabase:e}=t;let n;for(const i in t.connections)if(t.connections[i].databases.includes(e)){if(n)throw new Error(`Multiple connections found for migration database "${e}"`);n=t.connections[i]}if(!n)throw new Error(`Cannot connect to migration database - no connection found for database "${e}"`);return{database:e,host:n.host,port:n.port,username:n.username,password:n.password}}}const T=require("chalk");var b=o.n(T);require("reflect-metadata");class M{getMigrationClassInstance(t){return e=this,n=void 0,o=function*(){const e=(yield D.isCommonJS())?D.require(t.filepath):yield D.import(t.filepath);let n;const i=t.name.split("_").pop();if(e[i])n=e[i];else{if(!e.default)throw new Error(`Could not find migration class in ${t.filepath}`);n=e.default}return new n},new((i=void 0)||(i=Promise))((function(t,s){function r(t){try{l(o.next(t))}catch(t){s(t)}}function a(t){try{l(o.throw(t))}catch(t){s(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,a)}l((o=o.apply(e,n||[])).next())}));var e,n,i,o}}class N{static red(t){console.log(b().redBright(t))}static blue(t){console.log(b().blueBright(t))}static green(t){console.log(b().greenBright(t))}static yellow(t){console.log(b().yellowBright(t))}}class $ extends M{execute(){return t=this,e=void 0,i=function*(){const t=I.getConfig().migrationDirs,e=yield I.getProjectMigrations();for(const n in e){const i=e[n],{name:o}=t[n];if(N.yellow(o),0!==i.length)for(const t of i)t.executed?N.green(`  ${t.name}`):N.red(`  ${t.name}`);else N.red("  * No migrations found *")}},new((n=void 0)||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}}var C=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class A{constructor(t){this.connectionConfig=t}query(t,e=[]){return C(this,void 0,void 0,(function*(){return console.log("connection.query",t,e),(yield this.get()).query(t,e)}))}destroy(){return C(this,void 0,void 0,(function*(){this.connection&&(yield this.connection.destroy(),this.connection=void 0)}))}isInitialised(){return!!this.connection}escape(t){return C(this,void 0,void 0,(function*(){return(yield this.get()).driver.escape(t)}))}get(){return C(this,void 0,void 0,(function*(){return this.connection||(this.connection=new e.DataSource({type:"mysql",host:this.connectionConfig.host,port:this.connectionConfig.port,username:this.connectionConfig.username,password:this.connectionConfig.password}),yield this.connection.initialize()),this.connection}))}}var O,L;class S{constructor(t){this.config={},this.connections={},this.config=t}get(t){if(this.connections[t])return this.connections[t];if(!this.config[t])throw new Error(`Config for connection "${t}" not found`);const{host:e,port:n,username:i,password:o}=this.config[t];return this.connections[t]=new A({host:e,port:n,username:i,password:o}),this.connections[t]}getAllByDatabaseName(t){const e=[];for(const n in this.config)this.config[n].databases.includes(t)&&e.push(this.get(n));return e}destroyAllInitialised(){return t=this,e=void 0,i=function*(){const t=this.getAllInitialised();for(const e of t)yield e.destroy()},new((n=void 0)||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}getAllInitialised(){return Object.values(this.connections).filter((t=>t.isInitialised()))}}class U{constructor(t){this.columnExists=!1,this.name=t;const{valid:e,message:n}=this.validateColumnName(this.name);if(!e)throw new TypeError(`Invalid ${this.constructor.name} name: ${n}`)}getIndexDefinition(){return null}getName(){return this.name}exists(){return this.columnExists}update(){return this.columnExists=!0,this}validateColumnName(e){return t.Validators.all([t.Validators.string(),t.Validators.minLength(1),t.Validators.regex(/^[a-zA-Z_][a-zA-Z0-9_]{0,63}$/,"A-z, 0-9 and/or _")]).validate(e)}validateOptions(e,n){const{valid:i,message:o}=t.Validators.schema(n).validate(e);if(!i)throw new TypeError(`Invalid ${this.constructor.name} options. ${o}`);return!0}addNullableStatement(t,e){return e?`${t} NULL`:`${t} NOT NULL`}addDefaultStatement(t,e){return void 0!==e?`${t} DEFAULT ${e}`:t}addIndexStatement(t,e,n){return e?`${t}, ADD INDEX (${n})`:t}addUnsignedStatement(t,e){return e?`${t} UNSIGNED`:t}addZeroFillStatement(t,e){return e?`${t} ZEROFILL`:t}addAutoIncrementStatement(t,e){return e?`${t} AUTO_INCREMENT`:t}addPrimaryKeyStatement(t,e){return e?`${t} PRIMARY KEY`:t}addAfterStatement(t,e,n){return!n&&e&&N.yellow("WARNING: addAfter option is ignored when creating a new table."),n?(e&&(t+=` AFTER ${e}`),t):t}}!function(t){t.INDEX="INDEX",t.UNIQUE="UNIQUE",t.FULLTEXT="FULLTEXT"}(O||(O={}));class R{constructor(){this.indexColumns=[],this.indexType=O.INDEX,this.dropIndex=!1}static create(){return new R}isDrop(){return this.dropIndex}drop(t=!0){return this.dropIndex=t,this}defaultName(t){return this.defaultIndexName=t,this}name(t){return this.indexName=t,this}columns(...t){return this.indexColumns.push(...t),this}type(t){return this.indexType=t,this}get(){if(!this.isDrop()&&!this.indexColumns.length)throw new Error("No columns defined for index");const t=this.indexName||this.defaultIndexName;if(!t&&this.isDrop())throw new Error("No index name defined for drop index");let e=t&&this.indexType===O.UNIQUE?`${this.indexType} INDEX`:this.indexType;return t&&(e+=` \`${t}\``),this.isDrop()||(e+=` (${this.indexColumns.map((t=>`\`${t}\``)).join(", ")})`),e}}!function(t){t.BLOB="BLOB",t.TINYBLOB="TINYBLOB",t.MEDIUMBLOB="MEDIUMBLOB",t.LONGBLOB="LONGBLOB",t.DATE="DATE",t.DATETIME="DATETIME",t.DECIMAL="DECIMAL",t.DOUBLE="DOUBLE",t.ENUM="ENUM",t.INT="INT",t.TINYINT="TINYINT",t.SMALLINT="SMALLINT",t.MEDIUMINT="MEDIUMINT",t.BIGINT="BIGINT",t.CHAR="CHAR",t.VARCHAR="VARCHAR",t.TEXT="TEXT",t.TINYTEXT="TINYTEXT",t.MEDIUMTEXT="MEDIUMTEXT",t.LONGTEXT="LONGTEXT",t.TIME="TIME"}(L||(L={}));var B,_;class F{constructor(t,e){this.options={nullable:void 0,default:void 0,dropDefault:void 0,unsigned:void 0,autoIncrement:void 0,zeroFill:void 0,primaryKey:void 0,after:void 0},this.existingOptions={},this.name=t,this.type=e}static create(t,e){return new F(t,e)}nullable(t){return this.options.nullable=t,this}default(t){return this.options.default=t,this}dropDefault(t){return this.options.dropDefault=t,this}unsigned(t){return this.options.unsigned=t,this}autoIncrement(t){return this.options.autoIncrement=t,this}zeroFill(t){return this.options.zeroFill=t,this}primaryKey(t){return this.options.primaryKey=t,this}after(t){return this.options.after=t,this}get(){let t=`\`${this.name}\` ${this.type}`;!0===("boolean"==typeof this.options.unsigned?this.options.unsigned:this.existingOptions.unsigned)&&(t+=" UNSIGNED"),!0===("boolean"==typeof this.options.autoIncrement?this.options.autoIncrement:this.existingOptions.autoIncrement)&&(t+=" AUTO_INCREMENT"),!0===("boolean"==typeof this.options.zeroFill?this.options.zeroFill:this.existingOptions.zeroFill)&&(t+=" ZEROFILL");const e="boolean"==typeof this.options.nullable?this.options.nullable:this.existingOptions.nullable;if(t+=!0===e?" NULL":" NOT NULL",!0!==this.options.dropDefault){const n=void 0!==this.options.default?this.options.default:this.existingOptions.default;null===n&&!0===e?t+=" DEFAULT NULL":null!=n&&(t+=` DEFAULT ${n}`)}return!0===("boolean"==typeof this.options.primaryKey?this.options.primaryKey:this.existingOptions.primaryKey)&&(t+=" PRIMARY KEY"),"string"==typeof this.options.after&&(t+=` AFTER \`${this.options.after}\``),t}hydrateExistingOptions(t,e,n){return i=this,o=void 0,r=function*(){const[i]=yield t.query(`\n      SELECT\n        *\n      FROM\n        INFORMATION_SCHEMA.COLUMNS\n      WHERE\n        TABLE_NAME = '${n}'\n        AND COLUMN_NAME = '${e}';\n    `);if(!i)throw new Error(`Column "${e}" does not exist in table "${n}"`);const o=[L.DECIMAL,L.DOUBLE,L.INT,L.TINYINT,L.SMALLINT,L.MEDIUMINT,L.BIGINT].includes(this.type);this.existingType=i.COLUMN_TYPE.split(" ").shift(),this.existingOptions.nullable="YES"===i.IS_NULLABLE,this.existingOptions.default=null===i.COLUMN_DEFAULT&&"NO"===i.IS_NULLABLE?void 0:o||null==i.COLUMN_DEFAULT?i.COLUMN_DEFAULT:`'${i.COLUMN_DEFAULT}'`,this.existingOptions.dropDefault=!1,this.existingOptions.unsigned=i.COLUMN_TYPE.includes("unsigned"),this.existingOptions.autoIncrement=i.EXTRA.includes("auto_increment"),this.existingOptions.zeroFill=i.COLUMN_TYPE.includes("zerofill"),this.existingOptions.primaryKey="PRI"===i.COLUMN_KEY},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{l(r.next(t))}catch(t){e(t)}}function a(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(n,a)}l((r=r.apply(i,o||[])).next())}));var i,o,s,r}}class V extends U{constructor(){super(...arguments),this.options={},this.type=L.INT}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.integer().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}unsigned(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.unsigned: ${i}`);return this.options.unsigned=e,this}autoIncrement(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.autoIncrement: ${i}`);return this.options.autoIncrement=e,this}zeroFill(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.zeroFill: ${i}`);return this.options.zeroFill=e,this}primaryKey(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to IntColumn.primaryKey: ${i}`);return this.options.primaryKey=e,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to IntColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,this.type)),this.columnDefinition.nullable(this.options.nullable).default(this.options.default).dropDefault(this.options.dropDefault).unsigned(this.options.unsigned).autoIncrement(this.options.autoIncrement).zeroFill(this.options.zeroFill).primaryKey(this.options.primaryKey).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class j extends U{constructor(e,n=8,i=2){super(e),this.options={},this.precision=n,this.scale=i;const o=t.Validators.integer(),{valid:s,message:r}=o.validate(n);if(!1===s)throw new TypeError(`Invalid precision value passed to DecimalColumn.constructor: ${r}`);const{valid:a,message:l}=o.validate(i);if(!1===a)throw new TypeError(`Invalid scale value passed to DecimalColumn.constructor: ${l}`)}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DecimalColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.number().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DecimalColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}unsigned(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DecimalColumn.unsigned: ${i}`);return this.options.unsigned=e,this}zeroFill(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DecimalColumn.zeroFill: ${i}`);return this.options.zeroFill=e,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to DecimalColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,`${L.DECIMAL}(${this.precision}, ${this.scale})`)),this.columnDefinition.nullable(this.options.nullable).default("number"==typeof this.options.default?this.options.default.toFixed(this.scale):void 0).dropDefault(this.options.dropDefault).unsigned(this.options.unsigned).zeroFill(this.options.zeroFill).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class P extends U{constructor(e,n=255){super(e),this.options={},this.type=L.VARCHAR,this.length=n;const{valid:i,message:o}=t.Validators.integer().validate(n);if(!1===i)throw new TypeError(`Invalid value passed to StringColumn.constructor: ${o}`)}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to StringColumn.nullable: ${i}`);return this.options.nullable=e,this}primaryKey(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to StringColumn.primaryKey: ${i}`);return this.options.primaryKey=e,this}default(e){const{valid:n,message:i}=t.Validators.string().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to StringColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to StringColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,`${this.type}(${this.length})`)),this.columnDefinition.nullable(this.options.nullable).primaryKey(this.options.primaryKey).default(this.options.default?`'${this.options.default}'`:void 0).dropDefault(this.options.dropDefault).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class q extends U{constructor(){super(...arguments),this.options={}}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DateColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,"YYYY-MM-DD").validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DateColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to DateColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,L.DATE)),this.columnDefinition.nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).dropDefault(this.options.dropDefault).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class Y extends U{constructor(){super(...arguments),this.options={}}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to TimeColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"HH:MM:SS",{optional:!0}).validate(e);if(!1===n)throw new TypeError(`Invalid value passed to TimeColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to TimeColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,L.TIME)),this.columnDefinition.nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).dropDefault(this.options.dropDefault).after(this.options.after)}}class z extends U{constructor(){super(...arguments),this.options={}}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DateTimeColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.regex(/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]) ([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,"YYYY-MM-DD HH:MM:SS").validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DateTimeColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to DateTimeColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,L.DATETIME)),this.columnDefinition.nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).dropDefault(this.options.dropDefault).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class X extends U{constructor(){super(...arguments),this.options={},this.type=L.BLOB}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to BlobColumn.nullable: ${i}`);return this.options.nullable=e,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to BlobColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,this.type)),this.columnDefinition.nullable(this.options.nullable).after(this.options.after)}}class K extends U{constructor(e,n){super(e),this.options={},this.values=n;const{valid:i,message:o}=t.Validators.all([t.Validators.array(t.Validators.all([t.Validators.string(),t.Validators.minLength(1)])),t.Validators.minLength(1)]).validate(this.values);if(!i)throw new TypeError(`Invalid ${this.constructor.name} values. ${o}`)}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to EnumColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.string().validate(e),o={};for(const t of this.values)o[t]=t;const{valid:s,message:r}=t.Validators.enumValue(o).validate(e);if(!1===n||!1===s)throw new TypeError(`Invalid value passed to EnumColumn.default: ${i||r}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to EnumColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,`${L.ENUM}('${this.values.join("', '")}')`)),this.columnDefinition.nullable(this.options.nullable).default(this.options.default?`'${this.options.default}'`:void 0).dropDefault(this.options.dropDefault).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}class k extends U{constructor(e,n,i){super(e),this.options={},this.precision=n,this.scale=i;const o=t.Validators.integer({optional:!0}),{valid:s,message:r}=o.validate(n);if(!1===s)throw new TypeError(`Invalid precision value passed to DoubleColumn.constructor: ${r}`);const{valid:a,message:l}=o.validate(i);if(!1===a)throw new TypeError(`Invalid scale value passed to DoubleColumn.constructor: ${l}`);if(!(null==this.precision&&null==this.scale||null!=this.precision&&null!=this.scale))throw new Error(`Precision and scale must be both defined or both undefined in column ${this.name}`)}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DoubleColumn.nullable: ${i}`);return this.options.nullable=e,this}default(e){const{valid:n,message:i}=t.Validators.number().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DoubleColumn.default: ${i}`);return this.options.default=e,this}dropDefault(){return this.options.dropDefault=!0,this}zeroFill(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to DoubleColumn.zeroFill: ${i}`);return this.options.zeroFill=e,this}index(){return this.options.index=!0,this}dropIndex(){return this.options.dropIndex=!0,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to DoubleColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){if(!this.columnDefinition){const t=null!=this.precision&&null!=this.scale?`${L.DOUBLE}(${this.precision}, ${this.scale})`:L.DOUBLE;this.columnDefinition=F.create(this.name,t)}return this.columnDefinition.nullable(this.options.nullable).default("number"==typeof this.options.default?this.options.default.toFixed(this.scale):void 0).dropDefault(this.options.dropDefault).zeroFill(this.options.zeroFill).after(this.options.after)}getIndexDefinition(){return!this.options.index&&!this.exists()||!this.options.index&&!this.options.dropIndex?null:R.create().columns(this.name).drop(!0===this.options.dropIndex)}}!function(t){t.UTF8="utf8",t.UTF8MB4="utf8mb4"}(B||(B={})),function(t){t.UTF8_GENERAL_CI="utf8_general_ci",t.UTF8MB4_GENERAL_CI="utf8mb4_general_ci",t.UTF8MB4_UNICODE_CI="utf8mb4_unicode_ci"}(_||(_={}));class G{constructor(t,e){this.currentName=t,this.newName=e}getModificationDefinition(){return`RENAME COLUMN \`${this.currentName}\` TO \`${this.newName}\``}}class H{constructor(t){this.name=t}getModificationDefinition(){return`DROP COLUMN \`${this.name}\``}}class Q{constructor(t){this.definition=t}getModificationDefinition(){return`ADD ${this.definition.get()}`}}class Z{constructor(t){this.name=t}getModificationDefinition(){return`DROP INDEX \`${this.name}\``}}class J{constructor(t){this.name=t}getModificationDefinition(){return`DROP TABLE IF EXISTS \`${this.name}\``}}class W extends X{constructor(){super(...arguments),this.type=L.TINYBLOB}}class tt extends X{constructor(){super(...arguments),this.type=L.MEDIUMBLOB}}class et extends X{constructor(){super(...arguments),this.type=L.LONGBLOB}}class nt extends V{constructor(){super(...arguments),this.type=L.SMALLINT}}class it extends V{constructor(){super(...arguments),this.type=L.TINYINT}}class ot extends V{constructor(){super(...arguments),this.type=L.MEDIUMINT}}class st extends V{constructor(){super(...arguments),this.type=L.BIGINT}}class rt extends U{constructor(){super(...arguments),this.options={},this.type=L.TEXT}nullable(e=!0){const{valid:n,message:i}=t.Validators.boolean().validate(e);if(!1===n)throw new TypeError(`Invalid value passed to TextColumn.nullable: ${i}`);return this.options.nullable=e,this}after(t){const{valid:e,message:n}=this.validateColumnName(t);if(!1===e)throw new TypeError(`Invalid value passed to TextColumn.after: ${n}`);return this.options.after=t,this}getColumnDefinition(){return this.columnDefinition||(this.columnDefinition=F.create(this.name,this.type)),this.columnDefinition.nullable(this.options.nullable).after(this.options.after)}}class at extends rt{constructor(){super(...arguments),this.type=L.TINYTEXT}}class lt extends rt{constructor(){super(...arguments),this.type=L.MEDIUMTEXT}}class ut extends rt{constructor(){super(...arguments),this.type=L.LONGTEXT}}class ct{constructor(t,e,n,i,o){this.columns=[],this.alterModifications=[],this.standaloneModifications=[],this.name=t,this.connection=e,this.tableExists=i;const s=Object.assign({},{encoding:B.UTF8MB4,collation:_.UTF8MB4_GENERAL_CI},o);n.push((()=>{return t=this,e=void 0,i=function*(){if(0===this.columns.length&&0===this.alterModifications.length&&0===this.standaloneModifications.length)return;const{columnsToAdd:t,columnsToModify:e}=this.columns.reduce(((t,e)=>(e.exists()?t.columnsToModify.push(e):t.columnsToAdd.push(e),t)),{columnsToAdd:[],columnsToModify:[]});if(yield Promise.all(e.map((t=>t.getColumnDefinition().hydrateExistingOptions(this.connection,t.getName(),this.name)))),!this.tableExists&&t.length>0){const e=this.getCreateTableQuery(t,s);e&&(yield this.connection.query(e),this.tableExists=!0,t.splice(0,t.length))}if(t.length>0||e.length>0||this.alterModifications.length>0){const n=this.getAlterTableQuery(t,e,this.alterModifications);n&&(yield this.connection.query(n))}if(this.standaloneModifications.length>0){const t=this.standaloneModifications.map((t=>t.getModificationDefinition())).join("; ");yield this.connection.query(`${t};`)}},new((n=void 0)||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}))}id(t="id"){const e=new V(t).unsigned().autoIncrement().primaryKey();return this.columns.push(e),e}int(t){const e=new V(t);return this.columns.push(e),e}tinyint(t){const e=new it(t);return this.columns.push(e),e}smallint(t){const e=new nt(t);return this.columns.push(e),e}mediumint(t){const e=new ot(t);return this.columns.push(e),e}bigint(t){const e=new st(t);return this.columns.push(e),e}decimal(t,e=8,n=2){const i=new j(t,e,n);return this.columns.push(i),i}double(t,e,n){const i=new k(t,e,n);return this.columns.push(i),i}string(t,e=255){const n=new P(t,e);return this.columns.push(n),n}text(t){const e=new rt(t);return this.columns.push(e),e}tinytext(t){const e=new at(t);return this.columns.push(e),e}mediumtext(t){const e=new lt(t);return this.columns.push(e),e}longtext(t){const e=new ut(t);return this.columns.push(e),e}enum(t,e){const n=new K(t,e);return this.columns.push(n),n}date(t){const e=new q(t);return this.columns.push(e),e}time(t){const e=new Y(t);return this.columns.push(e),e}datetime(t){const e=new z(t);return this.columns.push(e),e}blob(t){const e=new X(t);return this.columns.push(e),e}tinyblob(t){const e=new W(t);return this.columns.push(e),e}mediumblob(t){const e=new tt(t);return this.columns.push(e),e}longblob(t){const e=new et(t);return this.columns.push(e),e}renameColumn(t,e){return this.alterModifications.push(new G(t,e)),this}dropColumn(t){return this.alterModifications.push(new H(t)),this}addIndex(t,e,n){const i=R.create().defaultName(this.getDefaultIndexName(...t)).columns(...t);return e&&i.name(e),n&&i.type(n),this.alterModifications.push(new Q(i)),this}dropIndex(...t){const[e]=t,n=Array.isArray(e)?this.getDefaultIndexName(...e):e;return this.alterModifications.push(new Z(n)),this}drop(){return this.standaloneModifications.push(new J(this.name)),this}getDefaultIndexName(...t){const e=t.sort().join("_").toLowerCase();return`${this.name.toLowerCase()}_${e}_index`}getCreateTableQuery(t,e){const n=[...t.map((t=>t.getColumnDefinition().get())),...t.map((t=>{const e=t.getIndexDefinition();return e?e.defaultName(this.getDefaultIndexName(t.getName())).get():null})).filter((t=>null!=t))];let i="";return e.encoding&&(i+=` DEFAULT CHARACTER SET ${e.encoding}`),e.collation&&(i+=` DEFAULT COLLATE ${e.collation}`),`CREATE TABLE \`${this.name}\` (${n.join(", ")})${i};`}getAlterTableQuery(t,e,n){const i=[...t.map((t=>`ADD COLUMN ${t.getColumnDefinition().get()}`)),...[...t,...e].map((t=>{const e=t.getIndexDefinition();return e?(e.defaultName(this.getDefaultIndexName(t.getName())),`${e.isDrop()?"DROP":"ADD"} ${e.get()}`):null})).filter((t=>null!=t)),...e.map((t=>`MODIFY COLUMN ${t.getColumnDefinition().get()}`)),...n.map((t=>t.getModificationDefinition()))];return 0===i.length?null:`ALTER TABLE \`${this.name}\` ${i.join(", ")};`}}class dt{constructor(t,e){this.connection=t,this.operations=e}create(t,e){return new ct(t,this.connection,this.operations,!1,e)}table(t){return new ct(t,this.connection,this.operations,!0)}}var ht=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class pt{constructor(t){this.operations=[],this.connections=t}database(t,e){let n;if(e)n=this.connections.get(e);else{const e=this.connections.getAllByDatabaseName(t);if(0===e.length)throw new Error(`No connections found for database "${t}"`);if(e.length>1)throw new Error(`Multiple connections found for database "${t}". Connection name must be specified.`);n=e[0]}return this.operations.push((()=>ht(this,void 0,void 0,(function*(){yield n.query(`CREATE DATABASE IF NOT EXISTS ${yield n.escape(t)};`)})))),this.operations.push((()=>ht(this,void 0,void 0,(function*(){yield n.query(`USE ${yield n.escape(t)};`)})))),new dt(n,this.operations)}executePendingOperations(){return ht(this,void 0,void 0,(function*(){for(;this.operations.length>0;){const t=this.operations.shift();yield t()}}))}}var ft=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class mt extends M{execute(){return ft(this,void 0,void 0,(function*(){const t=I.getConfig(),e=new S(t.connections),n=new pt(e);let i=0;const o=yield this.getMigrationsToRollBack();if(o.length){try{for(const{migrationRow:t,migrationFile:e}of o){N.yellow(`Rolling back: ${e.name}`);const o=yield this.getMigrationClassInstance(e);yield o.down(n),yield n.executePendingOperations(),yield I.getMigrationDb().getMigrationRepository().remove(t),i++,N.green(`Success: ${e.name}`),console.log("")}N.green(`Successfully rolled back ${i} migration${1!==i?"s":""}`)}catch(t){N.red(`Failed to roll back migrations: ${t.message}`),N.red(t.stack)}yield e.destroyAllInitialised()}else N.blue("No migrations to rollback")}))}getMigrationsToRollBack(){return ft(this,void 0,void 0,(function*(){const t=yield I.getMigrationDb().getMigrationRepository().getLatestBatch();if(!t)return[];const e=yield I.getMigrationDb().getMigrationRepository().getAllByBatch(t),n=yield I.getProjectMigrations();return Object.values(e).sort(((t,e)=>t.name<e.name?1:-1)).map((t=>{const e=n[t.group].find((e=>e.name===t.name));if(!e)throw new Error(`Could not find migration file for ${t.name} in group ${t.group}`);return{migrationRow:t,migrationFile:e}}))}))}}var gt=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class vt extends M{constructor(t){super(),this.options=t}execute(){var t;return gt(this,void 0,void 0,(function*(){let e=0;const n=I.getConfig(),i=new S(n.connections),o=new pt(i),s=yield this.getMigrationFilesToRun(),r=I.getMigrationDb().getMigrationRepository(),a=yield r.getLatestBatch(),l=a?a+1:1;try{for(const t of s){N.yellow(`Running: ${t.name}`);const n=yield this.getMigrationClassInstance(t);yield n.up(o),yield o.executePendingOperations();const i=new c;i.name=t.name,i.group=t.group,i.executed=d.DateTime.now().toSQL({includeOffset:!1}),i.batch=l,yield r.save(i),e++,N.green(`Success: ${t.name}`),console.log("")}N.green(`Successfully ran ${e} migration${1!==e?"s":""}`)}catch(n){N.red(`Failed to run migrations: ${n.message}`),N.red(n.stack),!0===(null===(t=this.options)||void 0===t?void 0:t.rollbackOnError)&&(e>0?(console.log(""),N.yellow("Attempting to roll back migrations..."),yield(new mt).execute()):(console.log(""),N.yellow("Nothing to roll back - 0 migrations finished successfully.")))}yield i.destroyAllInitialised()}))}getMigrationFilesToRun(){return gt(this,void 0,void 0,(function*(){const t=yield I.getProjectMigrations({includeExecuted:!1}),e=[];for(const n in t)e.push(...t[n]);return e.sort(((t,e)=>t.name<e.name?-1:1)),e}))}}class yt extends M{constructor(t,e){super(),this.migrationName=t,this.migrationDir=e}execute(){return t=this,e=void 0,i=function*(){const t=I.getConfig().migrationDirs,e=Object.keys(t);if(e.length>1&&!this.migrationDir)return void N.red("Migration directory must be specified when multiple migration directories are configured.");if(!1===/[A-z]+/.test(this.migrationName))return void N.red(`Invalid migration name: ${this.migrationName}. Must be a string with no spaces.`);if(e.length>1&&!1===e.includes(this.migrationDir))return void N.red(`Invalid migration directory: ${this.migrationDir}`);const n="true"===process.env.MIGRATE_TS,i=process.env.MIGRATE_JS_MODULE_TYPE||null;let o;o=n?this.getTypeScriptTemplate():"mjs"===i?this.getMjsTemplate():this.getCjsMigrationTemplate();const s=o.replace(/MigrationName/g,this.migrationName),r=t[this.migrationDir||e[0]].path,a=new Date,l=`${r}/${a.getFullYear()}_${(a.getMonth()+1).toString().padStart(2,"0")}_${a.getDate().toString().padStart(2,"0")}_${a.getHours().toString().padStart(2,"0")}${a.getMinutes().toString().padStart(2,"0")}${a.getSeconds().toString().padStart(2,"0")}_${this.migrationName}.${n?"ts":"js"}`;yield w().promises.writeFile(l,s),N.green(`Created migration file: ${l}`)},new((n=void 0)||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,n,i}getTypeScriptTemplate(){return'\n      import { AbstractMigration, MySql } from "@electra/migrate";\n\n      export class MigrationName extends AbstractMigration\n      {\n        public up(mysql: MySql)\n        {\n      \n        }\n      \n        public down(mysql: MySql)\n        {\n        \n        }\n      }\n\n    '}getMjsTemplate(){return'\n      import { AbstractMigration } from "@electra/migrate";\n\n      export class MigrationName extends AbstractMigration\n      {\n        up(mysql)\n        {\n      \n        }\n      \n        down(mysql)\n        {\n      \n        }\n      }\n    '}getCjsMigrationTemplate(){return'\n      const { AbstractMigration } = require("@electra/migrate");\n\n      module.exports = class MigrationName extends AbstractMigration\n      {\n        up(mysql)\n        {\n      \n        }\n      \n        down(mysql)\n        {\n      \n        }\n      }\n    '}}var wt=function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};function xt(t){return(e,n,i)=>wt(this,void 0,void 0,(function*(){yield I.ensureMigrationDbExists(),yield I.getMigrationDb().initialize(),yield t(e,n,i),yield I.getMigrationDb().destroy()}))}process.argv[1]="migrate",wt(void 0,void 0,void 0,(function*(){try{yield I.loadConfig();const{default:t}=yield Promise.resolve().then(o.t.bind(o,562,23));t.name("Electra Migrate").description("MySQL Migrations for Node.js Applications").version(o(147).i8),t.command("new","Create a new migration").argument("<name>","The name of the migration").argument("[group]","The group to add the migration to").action(xt((t=>wt(void 0,void 0,void 0,(function*(){yield new yt(t.name,t.group).execute()}))))),t.command("status","Show the status of all migrations").action(xt((()=>wt(void 0,void 0,void 0,(function*(){yield(new $).execute()}))))),t.command("run","Run all migrations").option("--rollback-on-error","Automatically rollback migrations if an error occurs").action(xt(((t,e)=>wt(void 0,void 0,void 0,(function*(){const t=new vt({rollbackOnError:e.rollbackOnError||!1});yield t.execute()}))))),t.command("rollback","Rollback the last batch of migrations").action(xt((()=>wt(void 0,void 0,void 0,(function*(){yield(new mt).execute()}))))),t.parse(process.argv)}catch(t){console.log(b().redBright(t.stack))}}))})(),module.exports=s})();
//# sourceMappingURL=migrate.cjs.map